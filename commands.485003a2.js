(()=>{"use strict";const e={GBP:{locale:"en-GB",currency:"GBP",format:"£#,##0.00"},USD:{locale:"en-US",currency:"USD",format:"$#,##0.00"},EUR:{locale:"de-DE",currency:"EUR",format:"€#,##0.00"}};let t="GBP";function n(n){e[n]&&(t=n)}function o(){return e[t].format}function r(n){if(null==n)return"—";const o="number"==typeof n?n:parseFloat(n);if(isNaN(o))return"—";const r=e[t];return new Intl.NumberFormat(r.locale,{style:"currency",currency:r.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}function a(e){if(null==e||""===e)return null;if("number"==typeof e)return isNaN(e)?null:e;const t=String(e).replace(/[$£€,\s]/g,"").trim();if(""===t)return null;const n=t.match(/^\((.+)\)$/);if(n){const e=parseFloat(n[1]);return isNaN(e)?null:-e}const o=parseFloat(t);return isNaN(o)?null:o}function i(e,t){const n=[];for(const[o,r]of t)o.startsWith(e)&&o!==e&&n.push({sku:o,entry:r});return n}function s(e){return String(e).trim().toUpperCase()}function l(e,t,n){for(const o of t)if(s(o[n])===e)return o[n];return e}function c(e){return Math.round(100*e)/100}const u=["sku","item number","product code","part number","item no","item #","material","product id","article","upc","ordered item","item"],f=["price","unit price","cost","amount","unit cost","net price","each","rate","ext price"],m=["product name","description","item description","product description","name","item name","product"],g=["qty","quantity","order qty","ordered qty","unit qty","units","ordered","order quantity","pcs","ea"];function d(e){return{sku:p(e,u),price:p(e,f),name:p(e,m),qty:p(e,g)}}function p(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const h="#1F4E79",y=["Status","SKU","Product Name","ERP $","PO $","Difference","% Diff","Action"];function w(e){return Math.round(100*e)/100}const $="#1F4E79",R="#FFFFFF",P="#A4262C";function k(e){const t=new Date;return`${e}_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const v=["delivery date","required date","ship date","due date","date required","req date","del date","arrival date","need by","need date","eta"],b=["po number","po no","po ref","po reference","purchase order","order number","order no","order ref","customer po","po#","order #"],E=["customer","customer name","sold to","bill to","buyer","account","account name","company","ship to name"],S=["uom","unit of measure","unit","pack size","pack","case size","inner","outer"],C=["line total","total","ext amount","extended","line amount","net amount","value","ext price"];function F(e){return{...d(e),deliveryDate:A(e,v),poRef:A(e,b),customer:A(e,E),uom:A(e,S),lineTotal:A(e,C)}}function O(e){return null==e?"":String(e).trim()}function N(e){if(null==e||""===e)return null;const t=String(e).trim(),n=new Date(t);if(!isNaN(n.getTime()))return n.toISOString().split("T")[0];const o=t.match(/^(\d{1,2})[/\-.](\d{1,2})[/\-.](\d{2,4})$/);if(o){const e=o[1].padStart(2,"0"),t=o[2].padStart(2,"0");let n=o[3];return 2===n.length&&(n="20"+n),`${n}-${t}-${e}`}return t}function A(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const x="#1F4E79",D="#FFFFFF",T=["#","SKU","Product Name","Qty","Unit Price","UOM","Line Total","Delivery Date","Status"];function q(e){const t=new Map;for(const n of e){const e=n.sku.toUpperCase().trim();t.has(e)||t.set(e,[]),t.get(e).push(n.lineNum)}const n=[];for(const[e,o]of t)o.length>1&&n.push({severity:"warning",rule:"duplicate-sku",field:"SKU",lines:o,message:`Duplicate SKU "${e}" on lines ${o.join(", ")}`});return n}function U(e){const t=e.filter(e=>0===e.price||null===e.price);return 0===t.length?[]:t.length===e.length?[{severity:"error",rule:"no-prices",message:"No rows have a valid price. Check column detection."}]:t.map(e=>({severity:"error",rule:"missing-price",field:"Price",lines:[e.lineNum],message:`Line ${e.lineNum} (${e.sku}): missing or zero price`}))}function I(e){const t=[];for(const n of e)n.qty<=0&&t.push({severity:"error",rule:"invalid-qty",field:"Qty",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): quantity is ${n.qty}`});return t}function B(e){const t=[];for(const n of e)n.price>0&&(n.price<.01||n.price>9999.99)&&t.push({severity:"warning",rule:"price-range",field:"Price",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): price ${n.price} outside expected range (0.01–9999.99)`});return t}function M(e){const t=e.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(t.length<5)return[];const n=t[Math.floor(t.length/2)],o=5*n,r=[];for(const t of e)t.qty>o&&r.push({severity:"warning",rule:"qty-outlier",field:"Qty",lines:[t.lineNum],message:`Line ${t.lineNum} (${t.sku}): quantity ${t.qty} is unusually large (median: ${n})`});return r}function L(e){const t=[];for(const n of e)if(n.lineTotal>0&&n.price>0&&n.qty>0){const e=Math.round(n.price*n.qty*100)/100;Math.abs(n.lineTotal-e)>.02&&t.push({severity:"warning",rule:"line-total-mismatch",field:"Line Total",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): total ${n.lineTotal} ≠ price × qty (${e})`})}return t}function j(e){const t=e.filter(e=>!e.name||""===e.name.trim());return 0===t.length?[]:e.some(e=>e.name&&e.name.trim())?[{severity:"info",rule:"missing-names",lines:t.map(e=>e.lineNum),message:`${t.length} row(s) missing product name`}]:[{severity:"info",rule:"no-names",message:"No product names detected — consider adding a Description column."}]}function K(e){const t=e.map(e=>e.sku),n=t.filter(e=>/[a-zA-Z]/.test(e)),o=t.filter(e=>/^\d+$/.test(e));return n.length>0&&o.length>0&&o.length<=.3*e.length?[{severity:"info",rule:"mixed-sku-format",message:`Mixed SKU formats: ${n.length} alphanumeric, ${o.length} numeric-only. This may affect ERP matching.`}]:[]}const Q="Ready",z="Review",W="Hold";function V(e){return Math.round(100*e)/100}const G="#1F4E79",H="#E2EFDA",_="#FFEB9C",Y="#FFC7CE";const J={results:null,poFilename:""};async function Z(e){const t=e?JSON.parse(e):{},u=t.tolerance??.02;let f,m,g,p;n(t.currency??"GBP"),await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.load("values"),await e.sync();const n=t.values;if(!n||n.length<2)throw new Error("Please select ERP data in Excel first (header row + data rows).");const o=n[0].map(e=>String(e).trim()).filter(Boolean),r=n.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return o.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(m=d(o),!m.sku||!m.price)throw new Error(`Could not detect SKU and Price columns in ERP data. Found headers: ${o.join(", ")}`);f={headers:o,rows:r}}),await Excel.run(async e=>{let t;const n=e.workbook.worksheets.getItemOrNullObject("PO");await e.sync(),t=n.isNullObject?e.workbook.worksheets.getFirst():n;const o=t.getUsedRange();o.load("values"),await e.sync();const r=o.values;if(!r||r.length<2)throw new Error("PO sheet has no data. Upload a PO file first.");const a=r[0].map(e=>String(e).trim()).filter(Boolean),i=r.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return a.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(p=d(a),!p.sku||!p.price)throw new Error(`Could not detect SKU and Price columns in PO data. Found headers: ${a.join(", ")}`);g={headers:a,rows:i},J.poFilename=t.name});const w=function({poData:e,poColumns:t,erpData:n,erpColumns:o,tolerance:r}){const u=new Map,f=new Set;for(const e of n.rows){const t=e[o.sku];if(!t)continue;const n=s(t);u.has(n)&&f.add(n),u.set(n,{price:a(e[o.price]),name:o.name&&e[o.name]||"",qty:o.qty&&a(e[o.qty])||1,originalRow:e,matched:!1})}const m=new Map;for(const n of e.rows){const e=n[t.sku];if(!e)continue;const o=s(e);m.set(o,(m.get(o)||0)+1)}const g=new Set;for(const[e,t]of m)t>1&&g.add(e);const d=[];let p=0,h=0,y=0,w=0,$=0;for(const m of e.rows){const e=m[t.sku];if(!e)continue;const R=s(e),P=a(m[t.price]),k=t.name&&m[t.name]||"",v=t.qty&&a(m[t.qty])||1,b=g.has(R)||f.has(R);if(null===P){$++,d.push({status:"Warning",sku:e,name:k,erpPrice:null,poPrice:null,diff:null,pctDiff:null,action:"Non-numeric price — skipped",duplicate:b,poQty:v,erpQty:null,lineTotal:null});continue}let E=u.get(R),S="exact";if(!E){const t=i(R,u);if(1===t.length)E=t[0].entry,S="prefix";else if(t.length>1){const n=t.map(e=>e.sku).join(", ");$++,d.push({status:"Warning",sku:e,name:k,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:`Multiple ERP matches: ${n}`,duplicate:b,poQty:v,erpQty:null,lineTotal:c(P*v)});continue}}if(!E){y++,d.push({status:"Not in ERP",sku:e,name:k,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:"Review — SKU not found in ERP",duplicate:b,poQty:v,erpQty:null,lineTotal:c(P*v)});continue}if(E.matched=!0,null===E.price){$++,d.push({status:"Warning",sku:e,name:E.name||k,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:"Non-numeric ERP price",duplicate:b,poQty:v,erpQty:E.qty,lineTotal:c(P*v)});continue}const C=c(P-E.price),F=Math.abs(C),O=0!==E.price?c(C/E.price*100):0!==C?100:0;let N,A;0===F?(N="Match",A="OK",p++):F<=r?(N="Tolerance",A="OK — within tolerance",h++):(N="Exception",A="Review pricing",y++,w+=F),d.push({status:N,sku:e,erpSku:"prefix"===S?l(i(R,u)[0].sku,n.rows,o.sku):null,name:E.name||k,erpPrice:E.price,poPrice:P,diff:C,pctDiff:O,action:"prefix"===S&&"OK"===A?"OK (prefix match)":A,duplicate:b,poQty:v,erpQty:E.qty,lineTotal:c(P*v)})}for(const[e,t]of u)t.matched||d.push({status:"Not in PO",sku:l(e,n.rows,o.sku),name:t.name,erpPrice:t.price,poPrice:null,diff:null,pctDiff:null,action:"Review — SKU not in PO",duplicate:f.has(e),poQty:null,erpQty:t.qty,lineTotal:null});const R={Exception:0,"Not in ERP":1,"Not in PO":2,Warning:3,Tolerance:4,Match:5};return d.sort((e,t)=>{const n=R[e.status]??99,o=R[t.status]??99;if(n!==o)return n-o;const r=null!=e.diff?Math.abs(e.diff):0;return(null!=t.diff?Math.abs(t.diff):0)-r}),{summary:{total:d.length,matches:p,tolerances:h,exceptions:y,exposure:c(w),warnings:$,timestamp:(new Date).toISOString()},rows:d}}({poData:g,poColumns:p,erpData:f,erpColumns:m,tolerance:u});J.results=w,await async function(e,t){await Excel.run(async n=>{const a=function(){const e=new Date;return`Recon_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),l=[["PO Reconciliation Summary",""],["Total Line Items",e.summary.total],["Perfect Matches",e.summary.matches],["Within Tolerance",e.summary.tolerances],["Exceptions",e.summary.exceptions],["Total $ Exposure",r(e.summary.exposure)],["Tolerance Used",r(t)],["Timestamp",(new Date).toLocaleString()]];s.getRange("A1:B8").values=l;const c=s.getRange("A1:B1");c.merge(),c.format.font.bold=!0,c.format.font.size=14,c.format.font.color=h,s.getRange("A2:A8").format.font.bold=!0;const u=s.getRange("A5:B5");u.format.font.color="#A4262C",u.format.font.bold=!0;const f=s.getRange("A10:H10");if(f.values=[y],f.format.font.bold=!0,f.format.font.color="#FFFFFF",f.format.fill.color=h,s.freezePanes.freezeRows(10),e.rows.length>0){const t=e.rows.map(e=>[e.duplicate?`${e.status} (DUP)`:e.status,e.erpSku?`${e.sku} → ${e.erpSku}`:e.sku,e.name||"",null!=e.erpPrice?e.erpPrice:"",null!=e.poPrice?e.poPrice:"",null!=e.diff?e.diff:"",null!=e.pctDiff?`${e.pctDiff}%`:"",e.action]),n=11,r=n+t.length-1;s.getRange(`A${n}:H${r}`).values=t;for(let t=0;t<e.rows.length;t++){const o=s.getRange(`A${n+t}:H${n+t}`),r=e.rows[t].status;"Exception"===r||"Not in ERP"===r||"Not in PO"===r?o.format.fill.color="#FFC7CE":"Tolerance"===r?o.format.fill.color="#FFEB9C":"Match"===r?o.format.fill.color="#C6EFCE":"Warning"===r&&(o.format.fill.color="#F2F2F2")}const a=["D","E","F"];for(const e of a)s.getRange(`${e}${n}:${e}${r}`).numberFormat=[[o()]]}s.getRange(`A1:H${10+e.rows.length}`).format.autofitColumns(),s.activate(),await n.sync()})}(w,u);const $=w.summary;return`Reconciliation complete.\n\nTotal items: ${$.total}\nPerfect matches: ${$.matches}\nWithin tolerance: ${$.tolerances}\nExceptions: ${$.exceptions}\nWarnings: ${$.warnings}\nTotal exposure: ${r($.exposure)}\n\nResults sheet created with color-coded status rows.`}async function X(e){if(!J.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=e?JSON.parse(e):{},n=function(e,t={}){const n=[];let o=0,r=0,a=0,i=0,s=0;for(const t of e.rows){if("Not in PO"===t.status)continue;if(null==t.poPrice&&null==t.erpPrice)continue;let e,l,c;switch(s++,t.status){case"Match":e=t.erpPrice??t.poPrice,l=Q,c="";break;case"Tolerance":e=t.erpPrice??t.poPrice,l=Q,c=`Within tolerance (diff: ${t.diff})`;break;case"Exception":e=t.erpPrice??t.poPrice,l=z,c=`Price exception: PO ${t.poPrice} vs ERP ${t.erpPrice} (diff: ${t.diff})`;break;case"Not in ERP":e=t.poPrice,l=W,c="SKU not found in ERP — verify item code";break;case"Warning":e=t.poPrice??0,l=W,c=t.action||"Data quality issue";break;default:e=t.erpPrice??t.poPrice??0,l=z,c=""}const u=t.poQty||1,f=V(e*u);o=V(o+f),l===Q?r++:l===z?a++:i++,n.push({lineNum:s,sku:t.sku,erpSku:t.erpSku||"",name:t.name||"",qty:u,uom:"EA",entryPrice:e,lineTotal:f,status:l,notes:c})}return{entryRows:n,totals:{lineCount:n.length,totalValue:o,readyCount:r,reviewCount:a,holdCount:i},metadata:{poRef:t.poRef||"Unknown",customer:t.customer||"Unknown",deliveryDate:t.deliveryDate||"",generatedAt:(new Date).toISOString(),reconciliationSummary:{matches:e.summary.matches,tolerances:e.summary.tolerances,exceptions:e.summary.exceptions,exposure:e.summary.exposure}}}}(J.results,{poRef:J.poFilename,customer:t.customer||"",deliveryDate:t.deliveryDate||""});await async function(e){await Excel.run(async t=>{const n=function(){const e=new Date;return`ERPStaging_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),a=t.workbook.worksheets.getItemOrNullObject(n);await t.sync(),a.isNullObject||(a.delete(),await t.sync());const i=t.workbook.worksheets.add(n),{entryRows:s,totals:l,metadata:c}=e,u=[["ERP Staging Sheet",""],["PO Reference",c.poRef],["Customer",c.customer],["Delivery Date",c.deliveryDate||"—"],["Generated",(new Date).toLocaleDateString()],["Total Lines",l.lineCount],["Total Value",r(l.totalValue)],["Status",`${l.readyCount} ready, ${l.reviewCount} review, ${l.holdCount} hold`]];i.getRange("A1:B8").values=u;const f=i.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=G,i.getRange("A2:A8").format.font.bold=!0;const m=["Line","SKU","ERP SKU","Description","Qty","UOM","Unit Price","Line Total","Status","Notes"],g=m.length,d=String.fromCharCode(64+g),p=i.getRange(`A10:${d}10`);if(p.values=[m],p.format.font.bold=!0,p.format.font.color="#FFFFFF",p.format.fill.color=G,i.freezePanes.freezeRows(10),s.length>0){const e=s.map(e=>[e.lineNum,e.sku,e.erpSku,e.name,e.qty,e.uom,e.entryPrice,e.lineTotal,e.status,e.notes]),t=11,n=t+e.length-1;i.getRange(`A${t}:${d}${n}`).values=e;for(const e of["G","H"])i.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<s.length;e++){const n=i.getRange(`A${t+e}:${d}${t+e}`);switch(s[e].status){case"Ready":n.format.fill.color=H;break;case"Review":n.format.fill.color=_;break;case"Hold":n.format.fill.color=Y}}const r=n+2,a=i.getRange(`A${r}:${d}${r}`);a.values=[["","","","","","","Total:",l.totalValue,"",""]],a.format.font.bold=!0,i.getRange(`H${r}`).numberFormat=[[o()]];const c=r+2;i.getRange(`A${c}`).values=[["Legend:"]],i.getRange(`A${c}`).format.font.bold=!0,i.getRange(`A${c+1}:B${c+1}`).values=[["Ready","Price verified — safe to enter into ERP"]],i.getRange(`A${c+1}:B${c+1}`).format.fill.color=H,i.getRange(`A${c+2}:B${c+2}`).values=[["Review","Price mismatch — operator decision needed"]],i.getRange(`A${c+2}:B${c+2}`).format.fill.color=_,i.getRange(`A${c+3}:B${c+3}`).values=[["Hold","Missing from ERP or data issue — cannot enter"]],i.getRange(`A${c+3}:B${c+3}`).format.fill.color=Y,i.getRange(`A1:${d}${c+3}`).format.autofitColumns()}else i.getRange(`A1:${d}10`).format.autofitColumns();i.activate(),await t.sync()})}(n);const a=n.totals;let i="ERP staging sheet created.\n\n";return i+=`PO Reference: ${n.metadata.poRef}\n`,i+=`Total lines: ${a.lineCount}\n`,i+=`Total value: ${r(a.totalValue)}\n\n`,i+="Status breakdown:\n",i+=`  Ready (green):  ${a.readyCount} — safe to enter into ERP\n`,i+=`  Review (yellow): ${a.reviewCount} — price exceptions, operator decision needed\n`,i+=`  Hold (red):     ${a.holdCount} — missing from ERP or data issue\n\n`,i+="The ERPStaging sheet has been activated. Green rows can be entered directly. Yellow rows need price confirmation. Red rows need item verification.",i}Office.onReady(()=>{}),Office.actions.associate("ExtractPOData",async e=>{try{return await async function(e){const t=e?JSON.parse(e):{},i=t.sheetName||null;let s;n(t.currency??"GBP"),await Excel.run(async e=>{let t;if(i){if(t=e.workbook.worksheets.getItemOrNullObject(i),await e.sync(),t.isNullObject)throw new Error(`Sheet "${i}" not found. Available sheets can be listed.`)}else t=e.workbook.worksheets.getActiveWorksheet();const n=t.getUsedRange();n.load("values"),t.load("name"),await e.sync();const o=n.values;if(!o||o.length<2)throw new Error("Sheet has no data. Open or paste PO data first.");let r=0,a=0;const l=["sku","item","product","price","cost","qty","quantity","description","name","unit","total","amount","date","order"];for(let e=0;e<Math.min(o.length,15);e++){let t=0;for(const n of o[e]){const e=String(n||"").toLowerCase().trim();if(!(e.length>40))for(const n of l)if(e.includes(n)){t++;break}}t>a&&(a=t,r=e)}const c=o[r].map(e=>String(e??"").trim()).filter(Boolean),u=o.slice(r+1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return c.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});s={headers:c,rows:u},J.poFilename=t.name});const l=F(s.headers),c=function(e,t){const n=t||F(e.headers);if(!n.sku)throw new Error("Cannot find SKU column. Available headers: "+e.headers.join(", "));const o=[],r=[];let i=null,s=null;for(let t=0;t<e.rows.length;t++){const l=e.rows[t],c=t+1,u=O(l[n.sku]);if(!u){r.push({line:c,field:"SKU",message:"Empty SKU — row skipped"});continue}const f=n.price?l[n.price]:null,m=null!=f?a(f):null;n.price&&null===m&&f&&r.push({line:c,field:"Price",message:`Non-numeric price: "${f}"`});const g=n.qty?l[n.qty]:null,d=null!=g?a(g):null;n.qty&&null===d&&g&&r.push({line:c,field:"Qty",message:`Non-numeric quantity: "${g}"`}),null!==d&&d<=0&&r.push({line:c,field:"Qty",message:`Zero or negative quantity: ${d}`});const p=n.name?O(l[n.name]):"",h=n.deliveryDate?N(l[n.deliveryDate]):null,y=n.uom?O(l[n.uom]):"",w=n.lineTotal?l[n.lineTotal]:null;let $=null!=w?a(w):null;if(null===$&&null!==m&&null!==d&&($=Math.round(m*d*100)/100),null!==$&&null!==m&&null!==d){const e=Math.round(m*d*100)/100;Math.abs($-e)>.02&&r.push({line:c,field:"Line Total",message:`Mismatch: ${$} vs expected ${e} (price × qty)`})}if(!i&&n.poRef){const e=O(l[n.poRef]);e&&(i=e)}if(!s&&n.customer){const e=O(l[n.customer]);e&&(s=e)}o.push({lineNum:c,sku:u,name:p,qty:d??1,price:m??0,uom:y,lineTotal:$??0,deliveryDate:h||"",status:"Pending"})}const l=o.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(l.length>=5){const e=l[Math.floor(l.length/2)],t=3*e;for(const n of o)n.qty>t&&r.push({line:n.lineNum,field:"Qty",message:`Unusually large quantity: ${n.qty} (median: ${e})`})}const c=o.reduce((e,t)=>e+t.lineTotal,0);return{stagingRows:o,metadata:{lineCount:o.length,totalValue:Math.round(100*c)/100,poRef:i||"Unknown",customer:s||"Unknown",detectedFields:Object.entries(n).filter(([,e])=>null!==e).map(([e])=>e),warningCount:r.length,extractedAt:(new Date).toISOString()},warnings:r}}(s,l);await async function(e){const{stagingRows:t,metadata:n,warnings:a}=e;await Excel.run(async e=>{const i=`Staging_${(n.poRef||"PO").replace(/[^a-zA-Z0-9-_]/g,"").slice(0,20)}`,s=e.workbook.worksheets.getItemOrNullObject(i);await e.sync(),s.isNullObject||(s.delete(),await e.sync());const l=e.workbook.worksheets.add(i),c=[["PO Staging Sheet",""],["PO Reference",n.poRef],["Customer",n.customer],["Line Items",n.lineCount],["Total Value",r(n.totalValue)],["Warnings",n.warningCount],["Extracted",(new Date).toLocaleString()]];l.getRange("A1:B7").values=c;const u=l.getRange("A1:B1");if(u.merge(),u.format.font.bold=!0,u.format.font.size=14,u.format.font.color=x,l.getRange("A2:A7").format.font.bold=!0,n.warningCount>0){const e=l.getRange("B6");e.format.font.color="#A4262C",e.format.font.bold=!0}const f=l.getRange("A9:I9");if(f.values=[T],f.format.font.bold=!0,f.format.font.color=D,f.format.fill.color=x,l.freezePanes.freezeRows(9),t.length>0){const e=new Map;for(const t of a)e.has(t.line)||e.set(t.line,[]),e.get(t.line).push(`${t.field}: ${t.message}`);const r=t.map(t=>[t.lineNum,t.sku,t.name,t.qty,t.price,t.uom,t.lineTotal,t.deliveryDate,e.has(t.lineNum)?"Review":t.status]),i=10,s=i+r.length-1;l.getRange(`A${i}:I${s}`).values=r;for(const e of["E","G"])l.getRange(`${e}${i}:${e}${s}`).numberFormat=[[o()]];l.getRange(`H${i}:H${s}`).numberFormat=[["yyyy-mm-dd"]];for(let n=0;n<t.length;n++){const o=l.getRange(`A${i+n}:I${i+n}`);e.has(t[n].lineNum)?(o.format.fill.color="#FFEB9C",l.getRange(`I${i+n}`).note=e.get(t[n].lineNum).join("\n")):o.format.fill.color="#E2EFDA"}const c=s+1,u=l.getRange(`A${c}:I${c}`);u.values=[["","","",t.reduce((e,t)=>e+t.qty,0),"","",n.totalValue,"",`${t.length} lines`]],u.format.font.bold=!0,l.getRange(`G${c}`).numberFormat=[[o()]],l.getRange(`A1:I${c}`).format.autofitColumns()}else l.getRange("A1:I9").format.autofitColumns();if(a.length>0){const t=i+"_Warnings",n=e.workbook.worksheets.getItemOrNullObject(t);await e.sync(),n.isNullObject||(n.delete(),await e.sync());const o=e.workbook.worksheets.add(t),r=["Line","Field","Warning"],s=o.getRange("A1:C1");s.values=[r],s.format.font.bold=!0,s.format.font.color=D,s.format.fill.color="#A4262C";const l=a.map(e=>[e.line,e.field,e.message]);o.getRange(`A2:C${1+l.length}`).values=l,o.getRange(`A1:C${1+l.length}`).format.autofitColumns()}l.activate(),await e.sync()})}(c);const u=function(e){const t=[...(n=e,0===n.length?[{severity:"error",rule:"no-data",message:"No data rows found. Check the source file."}]:[]),...q(e),...U(e),...I(e),...B(e),...M(e),...L(e),...j(e),...K(e)];var n;const o=t.filter(e=>"error"===e.severity),r=t.filter(e=>"warning"===e.severity),a=t.filter(e=>"info"===e.severity);return{valid:0===o.length,errors:o,warnings:r,info:a,summary:{total:t.length,errors:o.length,warnings:r.length,info:a.length}}}(c.stagingRows);J.lastExtraction=c,J.lastValidation=u;const f=c.metadata,m=f.detectedFields.join(", ");let g="PO data extracted and staging sheet created.\n\n";if(g+=`PO Reference: ${f.poRef}\n`,g+=`Customer: ${f.customer}\n`,g+=`Line items: ${f.lineCount}\n`,g+=`Total value: ${r(f.totalValue)}\n`,g+=`Detected fields: ${m}\n`,g+="\n--- Validation ---\n",g+=function(e){const t=[];if(e.valid?t.push("Validation passed."):t.push(`Validation failed — ${e.summary.errors} error(s) must be resolved.`),e.summary.warnings>0&&t.push(`${e.summary.warnings} warning(s) to review.`),e.errors.length>0){t.push(""),t.push("Errors:");for(const n of e.errors)t.push(`  ✗ ${n.message}`)}if(e.warnings.length>0){t.push(""),t.push("Warnings:");for(const n of e.warnings)t.push(`  ! ${n.message}`)}if(e.info.length>0){t.push(""),t.push("Info:");for(const n of e.info)t.push(`  ○ ${n.message}`)}return t.join("\n")}(u),f.warningCount>0){g+=`\n\nExtraction warnings: ${f.warningCount}\n`;const e=c.warnings.slice(0,5);for(const t of e)g+=`  Line ${t.line}: ${t.field} — ${t.message}\n`;c.warnings.length>5&&(g+=`  ... and ${c.warnings.length-5} more (see Warnings sheet)\n`),g+="\nYellow-highlighted rows need review. Check cell notes for details."}return u.valid?g+="\n\nData is ready for reconciliation.":g+="\n\nValidation errors must be resolved before reconciliation.",g}(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("ReconcilePO",async e=>{try{return await Z(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateCreditNote",async()=>{try{return await async function(){if(!J.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice)continue;const e=o.poQty||1,r=w(o.poPrice*e),a=w(-r);t.push({sku:o.sku,name:o.name||"",qty:e,originalPrice:o.poPrice,lineTotal:r,creditAmount:a}),n=w(n+a)}return{creditRows:t,totals:{lineCount:t.length,totalCredit:n}}}(J.results);await async function(e,t){await Excel.run(async n=>{const a=k("CreditNote"),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),{creditRows:l,totals:c}=e,u=[["Credit Note",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Total Lines",c.lineCount],["Total Credit",r(c.totalCredit)]];s.getRange("A1:B5").values=u;const f=s.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=$,s.getRange("A2:A5").format.font.bold=!0;const m=s.getRange("A5:B5");m.format.font.color=P,m.format.font.bold=!0;const g=s.getRange("A7:F7");if(g.values=[["SKU","Product Name","Qty","Original Price","Line Total","Credit Amount"]],g.format.font.bold=!0,g.format.font.color=R,g.format.fill.color=$,s.freezePanes.freezeRows(7),l.length>0){const e=l.map(e=>[e.sku,e.name,e.qty,e.originalPrice,e.lineTotal,e.creditAmount]),t=8,n=t+e.length-1;s.getRange(`A${t}:F${n}`).values=e;for(const e of["D","E","F"])s.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];s.getRange(`F${t}:F${n}`).format.font.color=P;const r=n+1,a=s.getRange(`A${r}:F${r}`);a.values=[["","","","","Total Credit:",c.totalCredit]],a.format.font.bold=!0;const i=s.getRange(`F${r}`);i.numberFormat=[[o()]],i.format.font.color=P,s.getRange(`A1:F${r}`).format.autofitColumns()}else s.getRange("A1:F7").format.autofitColumns();s.activate(),await n.sync()})}(e,J.poFilename);const t=e.totals;return`Credit note created.\n\nLines: ${t.lineCount}\nTotal credit: ${r(t.totalCredit)}\n\nThe CreditNote sheet has been activated.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateReInvoice",async()=>{try{return await async function(){if(!J.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice&&null==o.erpPrice)continue;const e=o.poQty||1,r=null!=o.erpPrice?o.erpPrice:o.poPrice,a=w(r*e),i=null!=o.erpPrice&&null!=o.poPrice&&o.erpPrice!==o.poPrice;t.push({sku:o.sku,name:o.name||"",qty:e,correctedPrice:r,lineTotal:a,priceChanged:i}),n=w(n+a)}return{invoiceRows:t,totals:{lineCount:t.length,totalInvoice:n}}}(J.results),t=J.results.summary.exceptions;await async function(e,t,n){await Excel.run(async a=>{const i=k("ReInvoice"),s=a.workbook.worksheets.getItemOrNullObject(i);await a.sync(),s.isNullObject||(s.delete(),await a.sync());const l=a.workbook.worksheets.add(i),{invoiceRows:c,totals:u}=e,f=[["Corrected Re-Invoice",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Corrected Total",r(u.totalInvoice)],["Price Corrections",n]];l.getRange("A1:B5").values=f;const m=l.getRange("A1:B1");m.merge(),m.format.font.bold=!0,m.format.font.size=14,m.format.font.color=$,l.getRange("A2:A5").format.font.bold=!0;const g=l.getRange("A7:E7");if(g.values=[["SKU","Product Name","Qty","Corrected Price","Line Total"]],g.format.font.bold=!0,g.format.font.color=R,g.format.fill.color=$,l.freezePanes.freezeRows(7),c.length>0){const e=c.map(e=>[e.sku,e.name,e.qty,e.correctedPrice,e.lineTotal]),t=8,n=t+e.length-1;l.getRange(`A${t}:E${n}`).values=e;for(const e of["D","E"])l.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<c.length;e++)c[e].priceChanged&&(l.getRange(`A${t+e}:E${t+e}`).format.fill.color="#FFEB9C");const r=n+1,a=l.getRange(`A${r}:E${r}`);a.values=[["","","","Total Invoice:",u.totalInvoice]],a.format.font.bold=!0,l.getRange(`E${r}`).numberFormat=[[o()]],l.getRange(`A1:E${r}`).format.autofitColumns()}else l.getRange("A1:E7").format.autofitColumns();l.activate(),await a.sync()})}(e,J.poFilename,t);const n=e.totals;return`Re-invoice created.\n\nLines: ${n.lineCount}\nCorrected total: ${r(n.totalInvoice)}\nPrice corrections: ${t}\n\nThe ReInvoice sheet has been activated. Yellow-highlighted rows indicate price corrections.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("DraftExceptionEmail",async()=>{try{return await async function(){if(!J.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e,t){const n=function(e){if(!e)return"Unknown";const t=e.replace(/\.[^.]+$/,""),n=t.match(/(?:PO[-_ ]?)(\d+[-\w]*)/i);return n?`PO-${n[1]}`:t}(t),{summary:o,rows:a}=e,i=a.filter(e=>"Exception"===e.status||"Not in ERP"===e.status||"Not in PO"===e.status),s=i.slice(0,3),l=`PO ${n} — Reconciliation: ${o.exceptions} exception${1!==o.exceptions?"s":""} found`,c=s.map(e=>"Not in ERP"===e.status?`  - SKU ${e.sku}: Not found in ERP`:"Not in PO"===e.status?`  - SKU ${e.sku}: In ERP but not on PO`:`  - SKU ${e.sku}: PO ${r(e.poPrice)} vs ERP ${r(e.erpPrice)} (diff: ${r(e.diff)})`);return{subject:l,body:`Hi Team,\n\nPO reconciliation for ${n} has been completed. Please see the summary below:\n\n  Total line items:    ${o.total}\n  Perfect matches:     ${o.matches}\n  Within tolerance:    ${o.tolerances}\n  Exceptions:          ${o.exceptions}\n  Total $ exposure:    ${r(o.exposure)}\n\n${o.exceptions>0?`Top exceptions:\n${c.join("\n")}\n${i.length>3?`  ... and ${i.length-3} more\n`:""}`:"All items matched within tolerance."}\nFull reconciliation details are in the Recon sheet attached to this workbook.\n${o.exceptions>0?"\nCredit note and corrected re-invoice sheets have been generated in this workbook.\n":""}\nPlease review and advise on next steps.\n\nBest regards`}}(J.results,J.poFilename);return`Subject: ${e.subject}\n\n${e.body}`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateERPStaging",async e=>{try{return await X(e)}catch(e){return`Error: ${e.message}`}})})();