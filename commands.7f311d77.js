(()=>{"use strict";const e={GBP:{locale:"en-GB",currency:"GBP",format:"£#,##0.00"},USD:{locale:"en-US",currency:"USD",format:"$#,##0.00"},EUR:{locale:"de-DE",currency:"EUR",format:"€#,##0.00"}};let t="GBP";function n(n){e[n]&&(t=n)}function o(){return e[t].format}function r(n){if(null==n)return"—";const o="number"==typeof n?n:parseFloat(n);if(isNaN(o))return"—";const r=e[t];return new Intl.NumberFormat(r.locale,{style:"currency",currency:r.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}function a(e){if(null==e||""===e)return null;if("number"==typeof e)return isNaN(e)?null:e;const t=String(e).replace(/[$£€,\s]/g,"").trim();if(""===t)return null;const n=t.match(/^\((.+)\)$/);if(n){const e=parseFloat(n[1]);return isNaN(e)?null:-e}const o=parseFloat(t);return isNaN(o)?null:o}function i(e,t){const n=[];for(const[o,r]of t)o.startsWith(e)&&o!==e&&n.push({sku:o,entry:r});return n}function s(e){return String(e).trim().toUpperCase()}function l(e,t,n){for(const o of t)if(s(o[n])===e)return o[n];return e}function c(e){return Math.round(100*e)/100}const u=["sku","item number","product code","part number","item no","item #","material","product id","article","upc","ordered item","item"],f=["price","unit price","cost","amount","unit cost","net price","each","rate","ext price"],g=["product name","description","item description","product description","name","item name","product"],m=["qty","quantity","order qty","ordered qty","unit qty","units","ordered","order quantity","pcs","ea"];function d(e){return{sku:p(e,u),price:p(e,f),name:p(e,g),qty:p(e,m)}}function p(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const h="#1F4E79",y=["Status","SKU","Product Name","ERP $","PO $","Difference","% Diff","Action"];function w(e){return Math.round(100*e)/100}const $="#1F4E79",R="#FFFFFF",P="#A4262C";function v(e){const t=new Date;return`${e}_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const b=["delivery date","required date","ship date","due date","date required","req date","del date","arrival date","need by","need date","eta"],k=["po number","po no","po ref","po reference","purchase order","order number","order no","order ref","customer po","po#","order #"],C=["customer","customer name","sold to","bill to","buyer","account","account name","company","ship to name"],S=["uom","unit of measure","unit","pack size","pack","case size","inner","outer"],x=["line total","total","ext amount","extended","line amount","net amount","value","ext price"];function E(e){return{...d(e),deliveryDate:N(e,b),poRef:N(e,k),customer:N(e,C),uom:N(e,S),lineTotal:N(e,x)}}function F(e){return null==e?"":String(e).trim()}function D(e){if(null==e||""===e)return null;const t=String(e).trim(),n=new Date(t);if(!isNaN(n.getTime()))return n.toISOString().split("T")[0];const o=t.match(/^(\d{1,2})[/\-.](\d{1,2})[/\-.](\d{2,4})$/);if(o){const e=o[1].padStart(2,"0"),t=o[2].padStart(2,"0");let n=o[3];return 2===n.length&&(n="20"+n),`${n}-${t}-${e}`}return t}function N(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const O="#1F4E79",A="#FFFFFF",T=["#","SKU","Product Name","Qty","Unit Price","UOM","Line Total","Delivery Date","Status"];function I(e){const t=new Map;for(const n of e){const e=n.sku.toUpperCase().trim();t.has(e)||t.set(e,[]),t.get(e).push(n.lineNum)}const n=[];for(const[e,o]of t)o.length>1&&n.push({severity:"warning",rule:"duplicate-sku",field:"SKU",lines:o,message:`Duplicate SKU "${e}" on lines ${o.join(", ")}`});return n}function U(e){const t=e.filter(e=>0===e.price||null===e.price);return 0===t.length?[]:t.length===e.length?[{severity:"error",rule:"no-prices",message:"No rows have a valid price. Check column detection."}]:t.map(e=>({severity:"error",rule:"missing-price",field:"Price",lines:[e.lineNum],message:`Line ${e.lineNum} (${e.sku}): missing or zero price`}))}function B(e){const t=[];for(const n of e)n.qty<=0&&t.push({severity:"error",rule:"invalid-qty",field:"Qty",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): quantity is ${n.qty}`});return t}function M(e){const t=[];for(const n of e)n.price>0&&(n.price<.01||n.price>9999.99)&&t.push({severity:"warning",rule:"price-range",field:"Price",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): price ${n.price} outside expected range (0.01–9999.99)`});return t}function q(e){const t=e.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(t.length<5)return[];const n=t[Math.floor(t.length/2)],o=5*n,r=[];for(const t of e)t.qty>o&&r.push({severity:"warning",rule:"qty-outlier",field:"Qty",lines:[t.lineNum],message:`Line ${t.lineNum} (${t.sku}): quantity ${t.qty} is unusually large (median: ${n})`});return r}function K(e){const t=[];for(const n of e)if(n.lineTotal>0&&n.price>0&&n.qty>0){const e=Math.round(n.price*n.qty*100)/100;Math.abs(n.lineTotal-e)>.02&&t.push({severity:"warning",rule:"line-total-mismatch",field:"Line Total",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): total ${n.lineTotal} ≠ price × qty (${e})`})}return t}function L(e){const t=e.filter(e=>!e.name||""===e.name.trim());return 0===t.length?[]:e.some(e=>e.name&&e.name.trim())?[{severity:"info",rule:"missing-names",lines:t.map(e=>e.lineNum),message:`${t.length} row(s) missing product name`}]:[{severity:"info",rule:"no-names",message:"No product names detected — consider adding a Description column."}]}function j(e){const t=e.map(e=>e.sku),n=t.filter(e=>/[a-zA-Z]/.test(e)),o=t.filter(e=>/^\d+$/.test(e));return n.length>0&&o.length>0&&o.length<=.3*e.length?[{severity:"info",rule:"mixed-sku-format",message:`Mixed SKU formats: ${n.length} alphanumeric, ${o.length} numeric-only. This may affect ERP matching.`}]:[]}const z="Ready",Q="Review",W="Hold";function G(e){return Math.round(100*e)/100}const H="#1F4E79",V="#E2EFDA",_="#FFEB9C",Y="#FFC7CE";function J(e){const t=e[e.length-1],n=t.name||e.find(e=>e.name)?.name||"",o=e.filter(e=>null!=e.erpPrice).map(e=>({date:e.date,price:e.erpPrice})),r=o.length>0?o[o.length-1].price:t.poPrice,a=o.length>=2?function(e){const t=e.length;if(t<2)return{direction:"insufficient",slope:0,confidence:0};const n=e.map((e,t)=>t),o=e.map(e=>e.price),r=X(n),a=X(o);let i=0,s=0;for(let e=0;e<t;e++)i+=(n[e]-r)*(o[e]-a),s+=(n[e]-r)**2;const l=0!==s?i/s:0,c=n.map(e=>a+l*(e-r)),u=o.reduce((e,t,n)=>e+(t-c[n])**2,0),f=o.reduce((e,t)=>e+(t-a)**2,0),g=f>0?1-u/f:0,m=0!==a?l/a*100:0;let d;return d=Math.abs(m)<.5?"stable":l>0?"up":"down",{direction:d,slope:te(l),slopePct:te(m),confidence:te(g)}}(o):{direction:"insufficient",slope:0,confidence:0};let i=null,s=null;if(o.length>=2){const e=o[o.length-2].price,t=o[o.length-1].price;i=te(t-e),s=0!==e?te((t-e)/e*100):0}const l=o.map(e=>e.price),c=l.length>=2?ee(l):0;let u=!1;if(l.length>=3){const e=X(l.slice(0,-1)),t=ee(l.slice(0,-1));t>0&&(u=Math.abs((l[l.length-1]-e)/t)>2)}const f=e.filter(e=>"Exception"===e.status).length,g=e.length>0?te(f/e.length*100):0,m=[];u&&m.push("Price anomaly"),"up"===a.direction&&a.confidence>.5&&m.push("Consistent price increase"),g>=50&&e.length>=2&&m.push("Frequent exceptions"),null!==s&&Math.abs(s)>10&&m.push("Large recent change (>"+Math.abs(s).toFixed(0)+"%)"),c>0&&r>0&&c/r>.1&&m.push("High volatility");let d=0;return u&&(d+=30),"up"===a.direction&&(d+=15),g>=50&&(d+=20),null!==s&&Math.abs(s)>5&&(d+=15),c>0&&r>0&&(d+=Math.min(20,c/r*200)),d=Math.min(100,Math.round(d)),{name:n,dataPoints:o.length,currentErpPrice:r,trend:a,lastChange:i,lastChangePct:s,volatility:te(c),anomaly:u,exceptionRate:g,exceptionCount:f,flags:m,riskScore:d}}function Z(e){return String(e).trim().toUpperCase()}function X(e){return e.length>0?e.reduce((e,t)=>e+t,0)/e.length:0}function ee(e){if(e.length<2)return 0;const t=X(e),n=e.reduce((e,n)=>e+(n-t)**2,0)/(e.length-1);return Math.sqrt(n)}function te(e){return Math.round(100*e)/100}const ne="PriceHistory",oe=["Date","PO Ref","SKU","Product Name","PO Price","ERP Price","Diff","Status","Qty"];function re(e){if(null==e||""===e)return null;const t=Number(e);return isNaN(t)?null:t}const ae="Dashboard",ie="#1f4e79",se="#ffffff",le="#d6e4f0",ce="#FFC7CE",ue="#E2EFDA",fe="#F2F2F2",ge="#FFC7CE",me="#FFEB9C",de={results:null,poFilename:""};async function pe(e){const t=e?JSON.parse(e):{},u=t.tolerance??.02;let f,g,m,p;n(t.currency??"GBP"),await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.load("values"),await e.sync();const n=t.values;if(!n||n.length<2)throw new Error("Please select ERP data in Excel first (header row + data rows).");const o=n[0].map(e=>String(e).trim()).filter(Boolean),r=n.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return o.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(g=d(o),!g.sku||!g.price)throw new Error(`Could not detect SKU and Price columns in ERP data. Found headers: ${o.join(", ")}`);f={headers:o,rows:r}}),await Excel.run(async e=>{let t;const n=e.workbook.worksheets.getItemOrNullObject("PO");await e.sync(),t=n.isNullObject?e.workbook.worksheets.getFirst():n;const o=t.getUsedRange();o.load("values"),await e.sync();const r=o.values;if(!r||r.length<2)throw new Error("PO sheet has no data. Upload a PO file first.");const a=r[0].map(e=>String(e).trim()).filter(Boolean),i=r.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return a.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(p=d(a),!p.sku||!p.price)throw new Error(`Could not detect SKU and Price columns in PO data. Found headers: ${a.join(", ")}`);m={headers:a,rows:i},de.poFilename=t.name});const w=function({poData:e,poColumns:t,erpData:n,erpColumns:o,tolerance:r}){const u=new Map,f=new Set;for(const e of n.rows){const t=e[o.sku];if(!t)continue;const n=s(t);u.has(n)&&f.add(n),u.set(n,{price:a(e[o.price]),name:o.name&&e[o.name]||"",qty:o.qty&&a(e[o.qty])||1,originalRow:e,matched:!1})}const g=new Map;for(const n of e.rows){const e=n[t.sku];if(!e)continue;const o=s(e);g.set(o,(g.get(o)||0)+1)}const m=new Set;for(const[e,t]of g)t>1&&m.add(e);const d=[];let p=0,h=0,y=0,w=0,$=0;for(const g of e.rows){const e=g[t.sku];if(!e)continue;const R=s(e),P=a(g[t.price]),v=t.name&&g[t.name]||"",b=t.qty&&a(g[t.qty])||1,k=m.has(R)||f.has(R);if(null===P){$++,d.push({status:"Warning",sku:e,name:v,erpPrice:null,poPrice:null,diff:null,pctDiff:null,action:"Non-numeric price — skipped",duplicate:k,poQty:b,erpQty:null,lineTotal:null});continue}let C=u.get(R),S="exact";if(!C){const t=i(R,u);if(1===t.length)C=t[0].entry,S="prefix";else if(t.length>1){const n=t.map(e=>e.sku).join(", ");$++,d.push({status:"Warning",sku:e,name:v,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:`Multiple ERP matches: ${n}`,duplicate:k,poQty:b,erpQty:null,lineTotal:c(P*b)});continue}}if(!C){y++,d.push({status:"Not in ERP",sku:e,name:v,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:"Review — SKU not found in ERP",duplicate:k,poQty:b,erpQty:null,lineTotal:c(P*b)});continue}if(C.matched=!0,null===C.price){$++,d.push({status:"Warning",sku:e,name:C.name||v,erpPrice:null,poPrice:P,diff:null,pctDiff:null,action:"Non-numeric ERP price",duplicate:k,poQty:b,erpQty:C.qty,lineTotal:c(P*b)});continue}const x=c(P-C.price),E=Math.abs(x),F=0!==C.price?c(x/C.price*100):0!==x?100:0;let D,N;0===E?(D="Match",N="OK",p++):E<=r?(D="Tolerance",N="OK — within tolerance",h++):(D="Exception",N="Review pricing",y++,w+=E),d.push({status:D,sku:e,erpSku:"prefix"===S?l(i(R,u)[0].sku,n.rows,o.sku):null,name:C.name||v,erpPrice:C.price,poPrice:P,diff:x,pctDiff:F,action:"prefix"===S&&"OK"===N?"OK (prefix match)":N,duplicate:k,poQty:b,erpQty:C.qty,lineTotal:c(P*b)})}for(const[e,t]of u)t.matched||d.push({status:"Not in PO",sku:l(e,n.rows,o.sku),name:t.name,erpPrice:t.price,poPrice:null,diff:null,pctDiff:null,action:"Review — SKU not in PO",duplicate:f.has(e),poQty:null,erpQty:t.qty,lineTotal:null});const R={Exception:0,"Not in ERP":1,"Not in PO":2,Warning:3,Tolerance:4,Match:5};return d.sort((e,t)=>{const n=R[e.status]??99,o=R[t.status]??99;if(n!==o)return n-o;const r=null!=e.diff?Math.abs(e.diff):0;return(null!=t.diff?Math.abs(t.diff):0)-r}),{summary:{total:d.length,matches:p,tolerances:h,exceptions:y,exposure:c(w),warnings:$,timestamp:(new Date).toISOString()},rows:d}}({poData:m,poColumns:p,erpData:f,erpColumns:g,tolerance:u});de.results=w,await async function(e,t){await Excel.run(async n=>{const a=function(){const e=new Date;return`Recon_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),l=[["PO Reconciliation Summary",""],["Total Line Items",e.summary.total],["Perfect Matches",e.summary.matches],["Within Tolerance",e.summary.tolerances],["Exceptions",e.summary.exceptions],["Total $ Exposure",r(e.summary.exposure)],["Tolerance Used",r(t)],["Timestamp",(new Date).toLocaleString()]];s.getRange("A1:B8").values=l;const c=s.getRange("A1:B1");c.merge(),c.format.font.bold=!0,c.format.font.size=14,c.format.font.color=h,s.getRange("A2:A8").format.font.bold=!0;const u=s.getRange("A5:B5");u.format.font.color="#A4262C",u.format.font.bold=!0;const f=s.getRange("A10:H10");if(f.values=[y],f.format.font.bold=!0,f.format.font.color="#FFFFFF",f.format.fill.color=h,s.freezePanes.freezeRows(10),e.rows.length>0){const t=e.rows.map(e=>[e.duplicate?`${e.status} (DUP)`:e.status,e.erpSku?`${e.sku} → ${e.erpSku}`:e.sku,e.name||"",null!=e.erpPrice?e.erpPrice:"",null!=e.poPrice?e.poPrice:"",null!=e.diff?e.diff:"",null!=e.pctDiff?`${e.pctDiff}%`:"",e.action]),n=11,r=n+t.length-1;s.getRange(`A${n}:H${r}`).values=t;for(let t=0;t<e.rows.length;t++){const o=s.getRange(`A${n+t}:H${n+t}`),r=e.rows[t].status;"Exception"===r||"Not in ERP"===r||"Not in PO"===r?o.format.fill.color="#FFC7CE":"Tolerance"===r?o.format.fill.color="#FFEB9C":"Match"===r?o.format.fill.color="#C6EFCE":"Warning"===r&&(o.format.fill.color="#F2F2F2")}const a=["D","E","F"];for(const e of a)s.getRange(`${e}${n}:${e}${r}`).numberFormat=[[o()]]}s.getRange(`A1:H${10+e.rows.length}`).format.autofitColumns(),s.activate(),await n.sync()})}(w,u);try{const e=(new Date).toISOString().slice(0,10),t=($=w,R=de.poFilename,P=e,$.rows.filter(e=>null!=e.poPrice&&"Not in PO"!==e.status).map(e=>({date:P,poRef:R,sku:e.sku,name:e.name||"",poPrice:e.poPrice,erpPrice:e.erpPrice,diff:e.diff,status:e.status,poQty:e.poQty||0})));await async function(e){e&&0!==e.length&&await Excel.run(async t=>{const n=t.workbook.worksheets;let o;try{o=n.getItem(ne),o.load("name"),await t.sync()}catch{o=n.add(ne);const e=o.getRangeByIndexes(0,0,1,oe.length);e.values=[oe],e.format.font.bold=!0,e.format.font.color="#ffffff",e.format.fill.color="#1f4e79",e.format.horizontalAlignment="Center";const r=[100,130,110,220,85,85,75,85,60];for(let e=0;e<r.length;e++)o.getRangeByIndexes(0,e,1,1).format.columnWidth=r[e];await t.sync()}const r=o.getUsedRangeOrNullObject(!0);r.load("rowCount"),await t.sync();const a=r.isNullObject?1:r.rowCount,i=e.map(e=>[e.date,e.poRef,e.sku,e.name,e.poPrice,null!=e.erpPrice?e.erpPrice:"",null!=e.diff?e.diff:"",e.status,e.poQty||""]);o.getRangeByIndexes(a,0,i.length,oe.length).values=i;const s="£#,##0.00";o.getRangeByIndexes(a,4,i.length,1).numberFormat=i.map(()=>[s]),o.getRangeByIndexes(a,5,i.length,1).numberFormat=i.map(()=>[s]),o.getRangeByIndexes(a,6,i.length,1).numberFormat=i.map(()=>[s]),await t.sync()})}(t)}catch{}var $,R,P;const v=w.summary;return`Reconciliation complete.\n\nTotal items: ${v.total}\nPerfect matches: ${v.matches}\nWithin tolerance: ${v.tolerances}\nExceptions: ${v.exceptions}\nWarnings: ${v.warnings}\nTotal exposure: ${r(v.exposure)}\n\nResults sheet created with color-coded status rows.`}async function he(e){if(!de.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=e?JSON.parse(e):{},n=function(e,t={}){const n=[];let o=0,r=0,a=0,i=0,s=0;for(const t of e.rows){if("Not in PO"===t.status)continue;if(null==t.poPrice&&null==t.erpPrice)continue;let e,l,c;switch(s++,t.status){case"Match":e=t.erpPrice??t.poPrice,l=z,c="";break;case"Tolerance":e=t.erpPrice??t.poPrice,l=z,c=`Within tolerance (diff: ${t.diff})`;break;case"Exception":e=t.erpPrice??t.poPrice,l=Q,c=`Price exception: PO ${t.poPrice} vs ERP ${t.erpPrice} (diff: ${t.diff})`;break;case"Not in ERP":e=t.poPrice,l=W,c="SKU not found in ERP — verify item code";break;case"Warning":e=t.poPrice??0,l=W,c=t.action||"Data quality issue";break;default:e=t.erpPrice??t.poPrice??0,l=Q,c=""}const u=t.poQty||1,f=G(e*u);o=G(o+f),l===z?r++:l===Q?a++:i++,n.push({lineNum:s,sku:t.sku,erpSku:t.erpSku||"",name:t.name||"",qty:u,uom:"EA",entryPrice:e,lineTotal:f,status:l,notes:c})}return{entryRows:n,totals:{lineCount:n.length,totalValue:o,readyCount:r,reviewCount:a,holdCount:i},metadata:{poRef:t.poRef||"Unknown",customer:t.customer||"Unknown",deliveryDate:t.deliveryDate||"",generatedAt:(new Date).toISOString(),reconciliationSummary:{matches:e.summary.matches,tolerances:e.summary.tolerances,exceptions:e.summary.exceptions,exposure:e.summary.exposure}}}}(de.results,{poRef:de.poFilename,customer:t.customer||"",deliveryDate:t.deliveryDate||""});await async function(e){await Excel.run(async t=>{const n=function(){const e=new Date;return`ERPStaging_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),a=t.workbook.worksheets.getItemOrNullObject(n);await t.sync(),a.isNullObject||(a.delete(),await t.sync());const i=t.workbook.worksheets.add(n),{entryRows:s,totals:l,metadata:c}=e,u=[["ERP Staging Sheet",""],["PO Reference",c.poRef],["Customer",c.customer],["Delivery Date",c.deliveryDate||"—"],["Generated",(new Date).toLocaleDateString()],["Total Lines",l.lineCount],["Total Value",r(l.totalValue)],["Status",`${l.readyCount} ready, ${l.reviewCount} review, ${l.holdCount} hold`]];i.getRange("A1:B8").values=u;const f=i.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=H,i.getRange("A2:A8").format.font.bold=!0;const g=["Line","SKU","ERP SKU","Description","Qty","UOM","Unit Price","Line Total","Status","Notes"],m=g.length,d=String.fromCharCode(64+m),p=i.getRange(`A10:${d}10`);if(p.values=[g],p.format.font.bold=!0,p.format.font.color="#FFFFFF",p.format.fill.color=H,i.freezePanes.freezeRows(10),s.length>0){const e=s.map(e=>[e.lineNum,e.sku,e.erpSku,e.name,e.qty,e.uom,e.entryPrice,e.lineTotal,e.status,e.notes]),t=11,n=t+e.length-1;i.getRange(`A${t}:${d}${n}`).values=e;for(const e of["G","H"])i.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<s.length;e++){const n=i.getRange(`A${t+e}:${d}${t+e}`);switch(s[e].status){case"Ready":n.format.fill.color=V;break;case"Review":n.format.fill.color=_;break;case"Hold":n.format.fill.color=Y}}const r=n+2,a=i.getRange(`A${r}:${d}${r}`);a.values=[["","","","","","","Total:",l.totalValue,"",""]],a.format.font.bold=!0,i.getRange(`H${r}`).numberFormat=[[o()]];const c=r+2;i.getRange(`A${c}`).values=[["Legend:"]],i.getRange(`A${c}`).format.font.bold=!0,i.getRange(`A${c+1}:B${c+1}`).values=[["Ready","Price verified — safe to enter into ERP"]],i.getRange(`A${c+1}:B${c+1}`).format.fill.color=V,i.getRange(`A${c+2}:B${c+2}`).values=[["Review","Price mismatch — operator decision needed"]],i.getRange(`A${c+2}:B${c+2}`).format.fill.color=_,i.getRange(`A${c+3}:B${c+3}`).values=[["Hold","Missing from ERP or data issue — cannot enter"]],i.getRange(`A${c+3}:B${c+3}`).format.fill.color=Y,i.getRange(`A1:${d}${c+3}`).format.autofitColumns()}else i.getRange(`A1:${d}10`).format.autofitColumns();i.activate(),await t.sync()})}(n);const a=n.totals;let i="ERP staging sheet created.\n\n";return i+=`PO Reference: ${n.metadata.poRef}\n`,i+=`Total lines: ${a.lineCount}\n`,i+=`Total value: ${r(a.totalValue)}\n\n`,i+="Status breakdown:\n",i+=`  Ready (green):  ${a.readyCount} — safe to enter into ERP\n`,i+=`  Review (yellow): ${a.reviewCount} — price exceptions, operator decision needed\n`,i+=`  Hold (red):     ${a.holdCount} — missing from ERP or data issue\n\n`,i+="The ERPStaging sheet has been activated. Green rows can be entered directly. Yellow rows need price confirmation. Red rows need item verification.",i}async function ye(){const e=await async function(){let e=[];return await Excel.run(async t=>{let n;try{n=t.workbook.worksheets.getItem(ne),n.load("name"),await t.sync()}catch{return}const o=n.getUsedRangeOrNullObject(!0);if(o.load(["values","rowCount"]),await t.sync(),o.isNullObject||o.rowCount<2)return;const r=o.values;for(let t=1;t<r.length;t++){const n=r[t];n[2]&&e.push({date:String(n[0]||""),poRef:String(n[1]||""),sku:String(n[2]||""),name:String(n[3]||""),poPrice:re(n[4]),erpPrice:re(n[5]),diff:re(n[6]),status:String(n[7]||""),poQty:re(n[8])||0})}}),e}();if(0===e.length)return"No price history available yet. Run at least one reconciliation to start building history. Each reconciliation automatically saves price data for trend analysis.";const t=function(e){if(!e||0===e.length)return{skuAnalysis:new Map,topMovers:[],watchList:[],metrics:{totalSKUs:0,totalRecords:0,totalRuns:0,avgDrift:0,exceptionRate:0,anomalyCount:0,trendingUp:0,trendingDown:0,stable:0,insufficientData:0}};const t=new Map;for(const n of e){const e=Z(n.sku);t.has(e)||t.set(e,[]),t.get(e).push(n)}const n=new Map;for(const[e,o]of t){const t=[...o].sort((e,t)=>e.date.localeCompare(t.date));n.set(e,J(t))}const o=[...n.entries()].filter(([,e])=>null!==e.lastChange&&e.dataPoints>=2).sort((e,t)=>Math.abs(t[1].lastChange)-Math.abs(e[1].lastChange)).slice(0,10).map(([e,t])=>({sku:e,name:t.name,lastChange:t.lastChange,lastChangePct:t.lastChangePct,direction:t.trend.direction,currentPrice:t.currentErpPrice,dataPoints:t.dataPoints})),r=[...n.entries()].filter(([,e])=>e.flags.length>0).sort((e,t)=>t[1].flags.length-e[1].flags.length||t[1].riskScore-e[1].riskScore).slice(0,15).map(([e,t])=>({sku:e,name:t.name,flags:t.flags,riskScore:t.riskScore,currentErpPrice:t.currentErpPrice,trend:t.trend.direction})),a=function(e,t){const n=t.size,o=e.length,r=new Set(e.map(e=>e.poRef+"|"+e.date)).size;let a=0,i=0,s=0,l=0,c=0,u=0,f=0;for(const[,e]of t)"up"===e.trend.direction?(s++,a+=e.trend.slopePct||0,i++):"down"===e.trend.direction?(l++,a+=e.trend.slopePct||0,i++):"stable"===e.trend.direction?(c++,i++):u++,e.anomaly&&f++;const g=i>0?te(a/i):0,m=e.filter(e=>"Exception"===e.status).length;return{totalSKUs:n,totalRecords:o,totalRuns:r,avgDrift:g,exceptionRate:o>0?te(m/o*100):0,anomalyCount:f,trendingUp:s,trendingDown:l,stable:c,insufficientData:u}}(e,n);return{skuAnalysis:n,topMovers:o,watchList:r,metrics:a}}(e);await async function(e){const{metrics:t,topMovers:n,watchList:o}=e;await Excel.run(async e=>{const r=e.workbook.worksheets;try{r.getItem(ae).delete(),await e.sync()}catch{}const a=r.add(ae);a.activate();let i=0;const s=a.getRangeByIndexes(i,0,1,7);s.merge(!0),s.values=[["Price Intelligence Dashboard"]],s.format.font.bold=!0,s.format.font.size=16,s.format.font.color=ie,i+=1;const l=a.getRangeByIndexes(i,0,1,7);l.merge(!0),l.values=[["Generated: "+(new Date).toLocaleDateString("en-GB")]],l.format.font.size=10,l.format.font.color="#797775",i+=2;const c=a.getRangeByIndexes(i,0,1,7);c.merge(!0),c.values=[["Summary"]],c.format.font.bold=!0,c.format.font.size=13,c.format.fill.color=le,i+=1;const u=[["SKUs Tracked",t.totalSKUs],["Reconciliation Runs",t.totalRuns],["Total Data Points",t.totalRecords],["Avg Price Drift",(t.avgDrift>=0?"+":"")+t.avgDrift.toFixed(2)+"%"],["Exception Rate",t.exceptionRate.toFixed(1)+"%"],["Anomalies Detected",t.anomalyCount]];for(const[e,t]of u){const n=a.getRangeByIndexes(i,0,1,2);n.merge(!0),n.values=[[e]],n.format.font.bold=!0;const o=a.getRangeByIndexes(i,2,1,2);o.merge(!0),o.values=[[t]],o.format.font.color="#1f4e79",o.format.font.size=12,o.format.font.bold=!0,i++}i+=1;const f=a.getRangeByIndexes(i,0,1,7);f.merge(!0),f.values=[["Trend Breakdown"]],f.format.font.bold=!0,f.format.font.size=13,f.format.fill.color=le,i+=1;const g=[["Trending Up",t.trendingUp,ce],["Trending Down",t.trendingDown,ue],["Stable",t.stable,fe],["Insufficient Data",t.insufficientData,"#F2F2F2"]];for(const[e,n,o]of g){const r=a.getRangeByIndexes(i,0,1,2);r.merge(!0),r.values=[[e]];const s=a.getRangeByIndexes(i,2,1,1);if(s.values=[[n]],s.format.font.bold=!0,n>0){const e=Math.min(4,Math.max(1,Math.round(n/t.totalSKUs*4)));a.getRangeByIndexes(i,3,1,e).format.fill.color=o}i++}if(i+=1,n.length>0){const e=a.getRangeByIndexes(i,0,1,7);e.merge(!0),e.values=[["Top Movers — Biggest Recent Price Changes"]],e.format.font.bold=!0,e.format.font.size=13,e.format.fill.color=le,i+=1;const t=["SKU","Product","Change","Change %","Current Price","Trend","Data Points"],o=a.getRangeByIndexes(i,0,1,t.length);o.values=[t],o.format.font.bold=!0,o.format.font.color=se,o.format.fill.color=ie,i+=1;for(const e of n){const t=e.lastChange>=0?"+":"",n=[e.sku,e.name,t+"£"+e.lastChange.toFixed(2),t+e.lastChangePct.toFixed(1)+"%","£"+e.currentPrice.toFixed(2),e.direction,e.dataPoints],o=a.getRangeByIndexes(i,0,1,n.length);o.values=[n];const r=e.lastChange>0?ce:e.lastChange<0?ue:fe;o.format.fill.color=r,i++}i+=1}if(o.length>0){const e=a.getRangeByIndexes(i,0,1,7);e.merge(!0),e.values=[["Watch List — SKUs Needing Attention"]],e.format.font.bold=!0,e.format.font.size=13,e.format.fill.color=le,i+=1;const t=["SKU","Product","Flags","Risk Score","Current Price","Trend"],n=a.getRangeByIndexes(i,0,1,t.length);n.values=[t],n.format.font.bold=!0,n.format.font.color=se,n.format.fill.color=ie,i+=1;for(const e of o){const t=[e.sku,e.name,e.flags.join("; "),e.riskScore,null!=e.currentErpPrice?"£"+e.currentErpPrice.toFixed(2):"",e.trend],n=a.getRangeByIndexes(i,0,1,t.length);n.values=[t],e.riskScore>=50?n.format.fill.color=ge:n.format.fill.color=me,i++}i+=1}if(0===n.length&&0===o.length){const e=a.getRangeByIndexes(i,0,1,7);e.merge(!0),e.values=[["Not enough historical data yet. Run more reconciliations to see trends and predictions."]],e.format.font.italic=!0,e.format.font.color="#797775",i+=2}const m=a.getRangeByIndexes(i,0,1,7);m.merge(!0),m.values=[["Legend"]],m.format.font.bold=!0,m.format.font.size=11,i+=1;const d=[[ce,"Price increasing — review supplier terms"],[ue,"Price decreasing — favorable trend"],[me,"Watch — approaching risk threshold"],[ge,"Anomaly — price outside expected range"]];for(const[e,t]of d){a.getRangeByIndexes(i,0,1,1).format.fill.color=e;const n=a.getRangeByIndexes(i,1,1,6);n.merge(!0),n.values=[[t]],n.format.font.size=10,n.format.font.color="#605e5c",i++}const p=[110,200,140,90,100,80,85];for(let e=0;e<p.length;e++)a.getRangeByIndexes(0,e,1,1).format.columnWidth=p[e];await e.sync()})}(t);const n=t.metrics;let o="Price Intelligence Dashboard created.\n\n";if(o+=`Data: ${n.totalRecords} records across ${n.totalRuns} reconciliation runs, ${n.totalSKUs} unique SKUs.\n\n`,o+="Key metrics:\n",o+=`  Average price drift: ${n.avgDrift>=0?"+":""}${n.avgDrift.toFixed(2)}%\n`,o+=`  Exception rate: ${n.exceptionRate.toFixed(1)}%\n`,o+=`  Anomalies detected: ${n.anomalyCount}\n\n`,o+="Trend breakdown:\n",o+=`  Trending up: ${n.trendingUp} SKUs\n`,o+=`  Trending down: ${n.trendingDown} SKUs\n`,o+=`  Stable: ${n.stable} SKUs\n`,t.topMovers.length>0){o+="\nTop movers (biggest recent price changes):\n";for(const e of t.topMovers.slice(0,5)){const t=e.lastChange>=0?"+":"";o+=`  ${e.sku} ${e.name}: ${t}£${e.lastChange.toFixed(2)} (${t}${e.lastChangePct.toFixed(1)}%)\n`}}if(t.watchList.length>0){o+="\nWatch list (SKUs needing attention):\n";for(const e of t.watchList.slice(0,5))o+=`  ${e.sku} ${e.name} — ${e.flags.join(", ")}\n`}return o+="\nThe Dashboard sheet has been activated with full details.",o}Office.onReady(()=>{}),Office.actions.associate("ExtractPOData",async e=>{try{return await async function(e){const t=e?JSON.parse(e):{},i=t.sheetName||null;let s;n(t.currency??"GBP"),await Excel.run(async e=>{let t;if(i){if(t=e.workbook.worksheets.getItemOrNullObject(i),await e.sync(),t.isNullObject)throw new Error(`Sheet "${i}" not found. Available sheets can be listed.`)}else t=e.workbook.worksheets.getActiveWorksheet();const n=t.getUsedRange();n.load("values"),t.load("name"),await e.sync();const o=n.values;if(!o||o.length<2)throw new Error("Sheet has no data. Open or paste PO data first.");let r=0,a=0;const l=["sku","item","product","price","cost","qty","quantity","description","name","unit","total","amount","date","order"];for(let e=0;e<Math.min(o.length,15);e++){let t=0;for(const n of o[e]){const e=String(n||"").toLowerCase().trim();if(!(e.length>40))for(const n of l)if(e.includes(n)){t++;break}}t>a&&(a=t,r=e)}const c=o[r].map(e=>String(e??"").trim()).filter(Boolean),u=o.slice(r+1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return c.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});s={headers:c,rows:u},de.poFilename=t.name});const l=E(s.headers),c=function(e,t){const n=t||E(e.headers);if(!n.sku)throw new Error("Cannot find SKU column. Available headers: "+e.headers.join(", "));const o=[],r=[];let i=null,s=null;for(let t=0;t<e.rows.length;t++){const l=e.rows[t],c=t+1,u=F(l[n.sku]);if(!u){r.push({line:c,field:"SKU",message:"Empty SKU — row skipped"});continue}const f=n.price?l[n.price]:null,g=null!=f?a(f):null;n.price&&null===g&&f&&r.push({line:c,field:"Price",message:`Non-numeric price: "${f}"`});const m=n.qty?l[n.qty]:null,d=null!=m?a(m):null;n.qty&&null===d&&m&&r.push({line:c,field:"Qty",message:`Non-numeric quantity: "${m}"`}),null!==d&&d<=0&&r.push({line:c,field:"Qty",message:`Zero or negative quantity: ${d}`});const p=n.name?F(l[n.name]):"",h=n.deliveryDate?D(l[n.deliveryDate]):null,y=n.uom?F(l[n.uom]):"",w=n.lineTotal?l[n.lineTotal]:null;let $=null!=w?a(w):null;if(null===$&&null!==g&&null!==d&&($=Math.round(g*d*100)/100),null!==$&&null!==g&&null!==d){const e=Math.round(g*d*100)/100;Math.abs($-e)>.02&&r.push({line:c,field:"Line Total",message:`Mismatch: ${$} vs expected ${e} (price × qty)`})}if(!i&&n.poRef){const e=F(l[n.poRef]);e&&(i=e)}if(!s&&n.customer){const e=F(l[n.customer]);e&&(s=e)}o.push({lineNum:c,sku:u,name:p,qty:d??1,price:g??0,uom:y,lineTotal:$??0,deliveryDate:h||"",status:"Pending"})}const l=o.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(l.length>=5){const e=l[Math.floor(l.length/2)],t=3*e;for(const n of o)n.qty>t&&r.push({line:n.lineNum,field:"Qty",message:`Unusually large quantity: ${n.qty} (median: ${e})`})}const c=o.reduce((e,t)=>e+t.lineTotal,0);return{stagingRows:o,metadata:{lineCount:o.length,totalValue:Math.round(100*c)/100,poRef:i||"Unknown",customer:s||"Unknown",detectedFields:Object.entries(n).filter(([,e])=>null!==e).map(([e])=>e),warningCount:r.length,extractedAt:(new Date).toISOString()},warnings:r}}(s,l);await async function(e){const{stagingRows:t,metadata:n,warnings:a}=e;await Excel.run(async e=>{const i=`Staging_${(n.poRef||"PO").replace(/[^a-zA-Z0-9-_]/g,"").slice(0,20)}`,s=e.workbook.worksheets.getItemOrNullObject(i);await e.sync(),s.isNullObject||(s.delete(),await e.sync());const l=e.workbook.worksheets.add(i),c=[["PO Staging Sheet",""],["PO Reference",n.poRef],["Customer",n.customer],["Line Items",n.lineCount],["Total Value",r(n.totalValue)],["Warnings",n.warningCount],["Extracted",(new Date).toLocaleString()]];l.getRange("A1:B7").values=c;const u=l.getRange("A1:B1");if(u.merge(),u.format.font.bold=!0,u.format.font.size=14,u.format.font.color=O,l.getRange("A2:A7").format.font.bold=!0,n.warningCount>0){const e=l.getRange("B6");e.format.font.color="#A4262C",e.format.font.bold=!0}const f=l.getRange("A9:I9");if(f.values=[T],f.format.font.bold=!0,f.format.font.color=A,f.format.fill.color=O,l.freezePanes.freezeRows(9),t.length>0){const e=new Map;for(const t of a)e.has(t.line)||e.set(t.line,[]),e.get(t.line).push(`${t.field}: ${t.message}`);const r=t.map(t=>[t.lineNum,t.sku,t.name,t.qty,t.price,t.uom,t.lineTotal,t.deliveryDate,e.has(t.lineNum)?"Review":t.status]),i=10,s=i+r.length-1;l.getRange(`A${i}:I${s}`).values=r;for(const e of["E","G"])l.getRange(`${e}${i}:${e}${s}`).numberFormat=[[o()]];l.getRange(`H${i}:H${s}`).numberFormat=[["yyyy-mm-dd"]];for(let n=0;n<t.length;n++){const o=l.getRange(`A${i+n}:I${i+n}`);e.has(t[n].lineNum)?(o.format.fill.color="#FFEB9C",l.getRange(`I${i+n}`).note=e.get(t[n].lineNum).join("\n")):o.format.fill.color="#E2EFDA"}const c=s+1,u=l.getRange(`A${c}:I${c}`);u.values=[["","","",t.reduce((e,t)=>e+t.qty,0),"","",n.totalValue,"",`${t.length} lines`]],u.format.font.bold=!0,l.getRange(`G${c}`).numberFormat=[[o()]],l.getRange(`A1:I${c}`).format.autofitColumns()}else l.getRange("A1:I9").format.autofitColumns();if(a.length>0){const t=i+"_Warnings",n=e.workbook.worksheets.getItemOrNullObject(t);await e.sync(),n.isNullObject||(n.delete(),await e.sync());const o=e.workbook.worksheets.add(t),r=["Line","Field","Warning"],s=o.getRange("A1:C1");s.values=[r],s.format.font.bold=!0,s.format.font.color=A,s.format.fill.color="#A4262C";const l=a.map(e=>[e.line,e.field,e.message]);o.getRange(`A2:C${1+l.length}`).values=l,o.getRange(`A1:C${1+l.length}`).format.autofitColumns()}l.activate(),await e.sync()})}(c);const u=function(e){const t=[...(n=e,0===n.length?[{severity:"error",rule:"no-data",message:"No data rows found. Check the source file."}]:[]),...I(e),...U(e),...B(e),...M(e),...q(e),...K(e),...L(e),...j(e)];var n;const o=t.filter(e=>"error"===e.severity),r=t.filter(e=>"warning"===e.severity),a=t.filter(e=>"info"===e.severity);return{valid:0===o.length,errors:o,warnings:r,info:a,summary:{total:t.length,errors:o.length,warnings:r.length,info:a.length}}}(c.stagingRows);de.lastExtraction=c,de.lastValidation=u;const f=c.metadata,g=f.detectedFields.join(", ");let m="PO data extracted and staging sheet created.\n\n";if(m+=`PO Reference: ${f.poRef}\n`,m+=`Customer: ${f.customer}\n`,m+=`Line items: ${f.lineCount}\n`,m+=`Total value: ${r(f.totalValue)}\n`,m+=`Detected fields: ${g}\n`,m+="\n--- Validation ---\n",m+=function(e){const t=[];if(e.valid?t.push("Validation passed."):t.push(`Validation failed — ${e.summary.errors} error(s) must be resolved.`),e.summary.warnings>0&&t.push(`${e.summary.warnings} warning(s) to review.`),e.errors.length>0){t.push(""),t.push("Errors:");for(const n of e.errors)t.push(`  ✗ ${n.message}`)}if(e.warnings.length>0){t.push(""),t.push("Warnings:");for(const n of e.warnings)t.push(`  ! ${n.message}`)}if(e.info.length>0){t.push(""),t.push("Info:");for(const n of e.info)t.push(`  ○ ${n.message}`)}return t.join("\n")}(u),f.warningCount>0){m+=`\n\nExtraction warnings: ${f.warningCount}\n`;const e=c.warnings.slice(0,5);for(const t of e)m+=`  Line ${t.line}: ${t.field} — ${t.message}\n`;c.warnings.length>5&&(m+=`  ... and ${c.warnings.length-5} more (see Warnings sheet)\n`),m+="\nYellow-highlighted rows need review. Check cell notes for details."}return u.valid?m+="\n\nData is ready for reconciliation.":m+="\n\nValidation errors must be resolved before reconciliation.",m}(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("ReconcilePO",async e=>{try{return await pe(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateCreditNote",async()=>{try{return await async function(){if(!de.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice)continue;const e=o.poQty||1,r=w(o.poPrice*e),a=w(-r);t.push({sku:o.sku,name:o.name||"",qty:e,originalPrice:o.poPrice,lineTotal:r,creditAmount:a}),n=w(n+a)}return{creditRows:t,totals:{lineCount:t.length,totalCredit:n}}}(de.results);await async function(e,t){await Excel.run(async n=>{const a=v("CreditNote"),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),{creditRows:l,totals:c}=e,u=[["Credit Note",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Total Lines",c.lineCount],["Total Credit",r(c.totalCredit)]];s.getRange("A1:B5").values=u;const f=s.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=$,s.getRange("A2:A5").format.font.bold=!0;const g=s.getRange("A5:B5");g.format.font.color=P,g.format.font.bold=!0;const m=s.getRange("A7:F7");if(m.values=[["SKU","Product Name","Qty","Original Price","Line Total","Credit Amount"]],m.format.font.bold=!0,m.format.font.color=R,m.format.fill.color=$,s.freezePanes.freezeRows(7),l.length>0){const e=l.map(e=>[e.sku,e.name,e.qty,e.originalPrice,e.lineTotal,e.creditAmount]),t=8,n=t+e.length-1;s.getRange(`A${t}:F${n}`).values=e;for(const e of["D","E","F"])s.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];s.getRange(`F${t}:F${n}`).format.font.color=P;const r=n+1,a=s.getRange(`A${r}:F${r}`);a.values=[["","","","","Total Credit:",c.totalCredit]],a.format.font.bold=!0;const i=s.getRange(`F${r}`);i.numberFormat=[[o()]],i.format.font.color=P,s.getRange(`A1:F${r}`).format.autofitColumns()}else s.getRange("A1:F7").format.autofitColumns();s.activate(),await n.sync()})}(e,de.poFilename);const t=e.totals;return`Credit note created.\n\nLines: ${t.lineCount}\nTotal credit: ${r(t.totalCredit)}\n\nThe CreditNote sheet has been activated.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateReInvoice",async()=>{try{return await async function(){if(!de.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice&&null==o.erpPrice)continue;const e=o.poQty||1,r=null!=o.erpPrice?o.erpPrice:o.poPrice,a=w(r*e),i=null!=o.erpPrice&&null!=o.poPrice&&o.erpPrice!==o.poPrice;t.push({sku:o.sku,name:o.name||"",qty:e,correctedPrice:r,lineTotal:a,priceChanged:i}),n=w(n+a)}return{invoiceRows:t,totals:{lineCount:t.length,totalInvoice:n}}}(de.results),t=de.results.summary.exceptions;await async function(e,t,n){await Excel.run(async a=>{const i=v("ReInvoice"),s=a.workbook.worksheets.getItemOrNullObject(i);await a.sync(),s.isNullObject||(s.delete(),await a.sync());const l=a.workbook.worksheets.add(i),{invoiceRows:c,totals:u}=e,f=[["Corrected Re-Invoice",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Corrected Total",r(u.totalInvoice)],["Price Corrections",n]];l.getRange("A1:B5").values=f;const g=l.getRange("A1:B1");g.merge(),g.format.font.bold=!0,g.format.font.size=14,g.format.font.color=$,l.getRange("A2:A5").format.font.bold=!0;const m=l.getRange("A7:E7");if(m.values=[["SKU","Product Name","Qty","Corrected Price","Line Total"]],m.format.font.bold=!0,m.format.font.color=R,m.format.fill.color=$,l.freezePanes.freezeRows(7),c.length>0){const e=c.map(e=>[e.sku,e.name,e.qty,e.correctedPrice,e.lineTotal]),t=8,n=t+e.length-1;l.getRange(`A${t}:E${n}`).values=e;for(const e of["D","E"])l.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<c.length;e++)c[e].priceChanged&&(l.getRange(`A${t+e}:E${t+e}`).format.fill.color="#FFEB9C");const r=n+1,a=l.getRange(`A${r}:E${r}`);a.values=[["","","","Total Invoice:",u.totalInvoice]],a.format.font.bold=!0,l.getRange(`E${r}`).numberFormat=[[o()]],l.getRange(`A1:E${r}`).format.autofitColumns()}else l.getRange("A1:E7").format.autofitColumns();l.activate(),await a.sync()})}(e,de.poFilename,t);const n=e.totals;return`Re-invoice created.\n\nLines: ${n.lineCount}\nCorrected total: ${r(n.totalInvoice)}\nPrice corrections: ${t}\n\nThe ReInvoice sheet has been activated. Yellow-highlighted rows indicate price corrections.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("DraftExceptionEmail",async()=>{try{return await async function(){if(!de.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e,t){const n=function(e){if(!e)return"Unknown";const t=e.replace(/\.[^.]+$/,""),n=t.match(/(?:PO[-_ ]?)(\d+[-\w]*)/i);return n?`PO-${n[1]}`:t}(t),{summary:o,rows:a}=e,i=a.filter(e=>"Exception"===e.status||"Not in ERP"===e.status||"Not in PO"===e.status),s=i.slice(0,3),l=`PO ${n} — Reconciliation: ${o.exceptions} exception${1!==o.exceptions?"s":""} found`,c=s.map(e=>"Not in ERP"===e.status?`  - SKU ${e.sku}: Not found in ERP`:"Not in PO"===e.status?`  - SKU ${e.sku}: In ERP but not on PO`:`  - SKU ${e.sku}: PO ${r(e.poPrice)} vs ERP ${r(e.erpPrice)} (diff: ${r(e.diff)})`);return{subject:l,body:`Hi Team,\n\nPO reconciliation for ${n} has been completed. Please see the summary below:\n\n  Total line items:    ${o.total}\n  Perfect matches:     ${o.matches}\n  Within tolerance:    ${o.tolerances}\n  Exceptions:          ${o.exceptions}\n  Total $ exposure:    ${r(o.exposure)}\n\n${o.exceptions>0?`Top exceptions:\n${c.join("\n")}\n${i.length>3?`  ... and ${i.length-3} more\n`:""}`:"All items matched within tolerance."}\nFull reconciliation details are in the Recon sheet attached to this workbook.\n${o.exceptions>0?"\nCredit note and corrected re-invoice sheets have been generated in this workbook.\n":""}\nPlease review and advise on next steps.\n\nBest regards`}}(de.results,de.poFilename);return`Subject: ${e.subject}\n\n${e.body}`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateERPStaging",async e=>{try{return await he(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateDashboard",async()=>{try{return await ye()}catch(e){return`Error: ${e.message}`}})})();