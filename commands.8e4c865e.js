(()=>{"use strict";const t={GBP:{locale:"en-GB",currency:"GBP",format:"£#,##0.00"},USD:{locale:"en-US",currency:"USD",format:"$#,##0.00"},EUR:{locale:"de-DE",currency:"EUR",format:"€#,##0.00"}};let e="GBP";function n(){return t[e].format}function o(n){if(null==n)return"—";const o="number"==typeof n?n:parseFloat(n);if(isNaN(o))return"—";const r=t[e];return new Intl.NumberFormat(r.locale,{style:"currency",currency:r.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}function r(t){if(null==t||""===t)return null;if("number"==typeof t)return isNaN(t)?null:t;const e=String(t).replace(/[$£€,\s]/g,"").trim();if(""===e)return null;const n=e.match(/^\((.+)\)$/);if(n){const t=parseFloat(n[1]);return isNaN(t)?null:-t}const o=parseFloat(e);return isNaN(o)?null:o}function a(t,e){const n=[];for(const[o,r]of e)o.startsWith(t)&&o!==t&&n.push({sku:o,entry:r});return n}function i(t){return String(t).trim().toUpperCase()}function c(t,e,n){for(const o of e)if(i(o[n])===t)return o[n];return t}function s(t){return Math.round(100*t)/100}const l=["sku","item number","product code","part number","item no","item #","material","product id","article","upc","ordered item","item"],u=["price","unit price","cost","amount","unit cost","net price","each","rate","ext price"],f=["product name","description","item description","product description","name","item name","product"],m=["qty","quantity","order qty","ordered qty","unit qty","units","ordered","order quantity","pcs","ea"];function p(t){return{sku:d(t,l),price:d(t,u),name:d(t,f),qty:d(t,m)}}function d(t,e){const n=t.map(t=>t.toLowerCase().trim());for(const o of e){const e=n.indexOf(o);if(-1!==e)return t[e]}for(const o of e){const e=n.findIndex(t=>t.includes(o));if(-1!==e)return t[e]}for(const o of e){const e=n.findIndex(t=>o.includes(t)&&t.length>=3);if(-1!==e)return t[e]}return null}const g="#1F4E79",h=["Status","SKU","Product Name","ERP $","PO $","Difference","% Diff","Action"];function w(t){return Math.round(100*t)/100}const P="#1F4E79",y="#FFFFFF",$="#A4262C";function R(t){const e=new Date;return`${t}_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}const k={results:null,poFilename:""};async function E(l){const u=l?JSON.parse(l):{},f=u.tolerance??.02,m=u.currency??"GBP";var d;let w,P,y,$;t[d=m]&&(e=d),await Excel.run(async t=>{const e=t.workbook.getSelectedRange();e.load("values"),await t.sync();const n=e.values;if(!n||n.length<2)throw new Error("Please select ERP data in Excel first (header row + data rows).");const o=n[0].map(t=>String(t).trim()).filter(Boolean),r=n.slice(1).filter(t=>t.some(t=>null!=t&&""!==String(t).trim())).map(t=>{const e={};return o.forEach((n,o)=>{e[n]=null!=t[o]?String(t[o]):""}),e});if(P=p(o),!P.sku||!P.price)throw new Error(`Could not detect SKU and Price columns in ERP data. Found headers: ${o.join(", ")}`);w={headers:o,rows:r}}),await Excel.run(async t=>{let e;const n=t.workbook.worksheets.getItemOrNullObject("PO");await t.sync(),e=n.isNullObject?t.workbook.worksheets.getFirst():n;const o=e.getUsedRange();o.load("values"),await t.sync();const r=o.values;if(!r||r.length<2)throw new Error("PO sheet has no data. Upload a PO file first.");const a=r[0].map(t=>String(t).trim()).filter(Boolean),i=r.slice(1).filter(t=>t.some(t=>null!=t&&""!==String(t).trim())).map(t=>{const e={};return a.forEach((n,o)=>{e[n]=null!=t[o]?String(t[o]):""}),e});if($=p(a),!$.sku||!$.price)throw new Error(`Could not detect SKU and Price columns in PO data. Found headers: ${a.join(", ")}`);y={headers:a,rows:i},k.poFilename=e.name});const R=function({poData:t,poColumns:e,erpData:n,erpColumns:o,tolerance:l}){const u=new Map,f=new Set;for(const t of n.rows){const e=t[o.sku];if(!e)continue;const n=i(e);u.has(n)&&f.add(n),u.set(n,{price:r(t[o.price]),name:o.name&&t[o.name]||"",qty:o.qty&&r(t[o.qty])||1,originalRow:t,matched:!1})}const m=new Map;for(const n of t.rows){const t=n[e.sku];if(!t)continue;const o=i(t);m.set(o,(m.get(o)||0)+1)}const p=new Set;for(const[t,e]of m)e>1&&p.add(t);const d=[];let g=0,h=0,w=0,P=0,y=0;for(const m of t.rows){const t=m[e.sku];if(!t)continue;const $=i(t),R=r(m[e.price]),k=e.name&&m[e.name]||"",E=e.qty&&r(m[e.qty])||1,b=p.has($)||f.has($);if(null===R){y++,d.push({status:"Warning",sku:t,name:k,erpPrice:null,poPrice:null,diff:null,pctDiff:null,action:"Non-numeric price — skipped",duplicate:b,poQty:E,erpQty:null,lineTotal:null});continue}let F=u.get($),O="exact";if(!F){const e=a($,u);if(1===e.length)F=e[0].entry,O="prefix";else if(e.length>1){const n=e.map(t=>t.sku).join(", ");y++,d.push({status:"Warning",sku:t,name:k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:`Multiple ERP matches: ${n}`,duplicate:b,poQty:E,erpQty:null,lineTotal:s(R*E)});continue}}if(!F){w++,d.push({status:"Not in ERP",sku:t,name:k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Review — SKU not found in ERP",duplicate:b,poQty:E,erpQty:null,lineTotal:s(R*E)});continue}if(F.matched=!0,null===F.price){y++,d.push({status:"Warning",sku:t,name:F.name||k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Non-numeric ERP price",duplicate:b,poQty:E,erpQty:F.qty,lineTotal:s(R*E)});continue}const C=s(R-F.price),v=Math.abs(C),S=0!==F.price?s(C/F.price*100):0!==C?100:0;let x,N;0===v?(x="Match",N="OK",g++):v<=l?(x="Tolerance",N="OK — within tolerance",h++):(x="Exception",N="Review pricing",w++,P+=v),d.push({status:x,sku:t,erpSku:"prefix"===O?c(a($,u)[0].sku,n.rows,o.sku):null,name:F.name||k,erpPrice:F.price,poPrice:R,diff:C,pctDiff:S,action:"prefix"===O&&"OK"===N?"OK (prefix match)":N,duplicate:b,poQty:E,erpQty:F.qty,lineTotal:s(R*E)})}for(const[t,e]of u)e.matched||d.push({status:"Not in PO",sku:c(t,n.rows,o.sku),name:e.name,erpPrice:e.price,poPrice:null,diff:null,pctDiff:null,action:"Review — SKU not in PO",duplicate:f.has(t),poQty:null,erpQty:e.qty,lineTotal:null});const $={Exception:0,"Not in ERP":1,"Not in PO":2,Warning:3,Tolerance:4,Match:5};return d.sort((t,e)=>{const n=$[t.status]??99,o=$[e.status]??99;if(n!==o)return n-o;const r=null!=t.diff?Math.abs(t.diff):0;return(null!=e.diff?Math.abs(e.diff):0)-r}),{summary:{total:d.length,matches:g,tolerances:h,exceptions:w,exposure:s(P),warnings:y,timestamp:(new Date).toISOString()},rows:d}}({poData:y,poColumns:$,erpData:w,erpColumns:P,tolerance:f});k.results=R,await async function(t,e){await Excel.run(async r=>{const a=function(){const t=new Date;return`Recon_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}(),i=r.workbook.worksheets.getItemOrNullObject(a);await r.sync(),i.isNullObject||(i.delete(),await r.sync());const c=r.workbook.worksheets.add(a),s=[["PO Reconciliation Summary",""],["Total Line Items",t.summary.total],["Perfect Matches",t.summary.matches],["Within Tolerance",t.summary.tolerances],["Exceptions",t.summary.exceptions],["Total $ Exposure",o(t.summary.exposure)],["Tolerance Used",o(e)],["Timestamp",(new Date).toLocaleString()]];c.getRange("A1:B8").values=s;const l=c.getRange("A1:B1");l.merge(),l.format.font.bold=!0,l.format.font.size=14,l.format.font.color=g,c.getRange("A2:A8").format.font.bold=!0;const u=c.getRange("A5:B5");u.format.font.color="#A4262C",u.format.font.bold=!0;const f=c.getRange("A10:H10");if(f.values=[h],f.format.font.bold=!0,f.format.font.color="#FFFFFF",f.format.fill.color=g,c.freezePanes.freezeRows(10),t.rows.length>0){const e=t.rows.map(t=>[t.duplicate?`${t.status} (DUP)`:t.status,t.erpSku?`${t.sku} → ${t.erpSku}`:t.sku,t.name||"",null!=t.erpPrice?t.erpPrice:"",null!=t.poPrice?t.poPrice:"",null!=t.diff?t.diff:"",null!=t.pctDiff?`${t.pctDiff}%`:"",t.action]),o=11,r=o+e.length-1;c.getRange(`A${o}:H${r}`).values=e;for(let e=0;e<t.rows.length;e++){const n=c.getRange(`A${o+e}:H${o+e}`),r=t.rows[e].status;"Exception"===r||"Not in ERP"===r||"Not in PO"===r?n.format.fill.color="#FFC7CE":"Tolerance"===r?n.format.fill.color="#FFEB9C":"Match"===r?n.format.fill.color="#C6EFCE":"Warning"===r&&(n.format.fill.color="#F2F2F2")}const a=["D","E","F"];for(const t of a)c.getRange(`${t}${o}:${t}${r}`).numberFormat=[[n()]]}c.getRange(`A1:H${10+t.rows.length}`).format.autofitColumns(),c.activate(),await r.sync()})}(R,f);const E=R.summary;return`Reconciliation complete.\n\nTotal items: ${E.total}\nPerfect matches: ${E.matches}\nWithin tolerance: ${E.tolerances}\nExceptions: ${E.exceptions}\nWarnings: ${E.warnings}\nTotal exposure: ${o(E.exposure)}\n\nResults sheet created with color-coded status rows.`}Office.onReady(()=>{}),Office.actions.associate("ReconcilePO",async t=>{try{return await E(t)}catch(t){return`Error: ${t.message}`}}),Office.actions.associate("GenerateCreditNote",async()=>{try{return await async function(){if(!k.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=function(t){const e=[];let n=0;for(const o of t.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice)continue;const t=o.poQty||1,r=w(o.poPrice*t),a=w(-r);e.push({sku:o.sku,name:o.name||"",qty:t,originalPrice:o.poPrice,lineTotal:r,creditAmount:a}),n=w(n+a)}return{creditRows:e,totals:{lineCount:e.length,totalCredit:n}}}(k.results);await async function(t,e){await Excel.run(async r=>{const a=R("CreditNote"),i=r.workbook.worksheets.getItemOrNullObject(a);await r.sync(),i.isNullObject||(i.delete(),await r.sync());const c=r.workbook.worksheets.add(a),{creditRows:s,totals:l}=t,u=[["Credit Note",""],["Date",(new Date).toLocaleDateString()],["PO Reference",e||"—"],["Total Lines",l.lineCount],["Total Credit",o(l.totalCredit)]];c.getRange("A1:B5").values=u;const f=c.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=P,c.getRange("A2:A5").format.font.bold=!0;const m=c.getRange("A5:B5");m.format.font.color=$,m.format.font.bold=!0;const p=c.getRange("A7:F7");if(p.values=[["SKU","Product Name","Qty","Original Price","Line Total","Credit Amount"]],p.format.font.bold=!0,p.format.font.color=y,p.format.fill.color=P,c.freezePanes.freezeRows(7),s.length>0){const t=s.map(t=>[t.sku,t.name,t.qty,t.originalPrice,t.lineTotal,t.creditAmount]),e=8,o=e+t.length-1;c.getRange(`A${e}:F${o}`).values=t;for(const t of["D","E","F"])c.getRange(`${t}${e}:${t}${o}`).numberFormat=[[n()]];c.getRange(`F${e}:F${o}`).format.font.color=$;const r=o+1,a=c.getRange(`A${r}:F${r}`);a.values=[["","","","","Total Credit:",l.totalCredit]],a.format.font.bold=!0;const i=c.getRange(`F${r}`);i.numberFormat=[[n()]],i.format.font.color=$,c.getRange(`A1:F${r}`).format.autofitColumns()}else c.getRange("A1:F7").format.autofitColumns();c.activate(),await r.sync()})}(t,k.poFilename);const e=t.totals;return`Credit note created.\n\nLines: ${e.lineCount}\nTotal credit: ${o(e.totalCredit)}\n\nThe CreditNote sheet has been activated.`}()}catch(t){return`Error: ${t.message}`}}),Office.actions.associate("GenerateReInvoice",async()=>{try{return await async function(){if(!k.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=function(t){const e=[];let n=0;for(const o of t.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice&&null==o.erpPrice)continue;const t=o.poQty||1,r=null!=o.erpPrice?o.erpPrice:o.poPrice,a=w(r*t),i=null!=o.erpPrice&&null!=o.poPrice&&o.erpPrice!==o.poPrice;e.push({sku:o.sku,name:o.name||"",qty:t,correctedPrice:r,lineTotal:a,priceChanged:i}),n=w(n+a)}return{invoiceRows:e,totals:{lineCount:e.length,totalInvoice:n}}}(k.results),e=k.results.summary.exceptions;await async function(t,e,r){await Excel.run(async a=>{const i=R("ReInvoice"),c=a.workbook.worksheets.getItemOrNullObject(i);await a.sync(),c.isNullObject||(c.delete(),await a.sync());const s=a.workbook.worksheets.add(i),{invoiceRows:l,totals:u}=t,f=[["Corrected Re-Invoice",""],["Date",(new Date).toLocaleDateString()],["PO Reference",e||"—"],["Corrected Total",o(u.totalInvoice)],["Price Corrections",r]];s.getRange("A1:B5").values=f;const m=s.getRange("A1:B1");m.merge(),m.format.font.bold=!0,m.format.font.size=14,m.format.font.color=P,s.getRange("A2:A5").format.font.bold=!0;const p=s.getRange("A7:E7");if(p.values=[["SKU","Product Name","Qty","Corrected Price","Line Total"]],p.format.font.bold=!0,p.format.font.color=y,p.format.fill.color=P,s.freezePanes.freezeRows(7),l.length>0){const t=l.map(t=>[t.sku,t.name,t.qty,t.correctedPrice,t.lineTotal]),e=8,o=e+t.length-1;s.getRange(`A${e}:E${o}`).values=t;for(const t of["D","E"])s.getRange(`${t}${e}:${t}${o}`).numberFormat=[[n()]];for(let t=0;t<l.length;t++)l[t].priceChanged&&(s.getRange(`A${e+t}:E${e+t}`).format.fill.color="#FFEB9C");const r=o+1,a=s.getRange(`A${r}:E${r}`);a.values=[["","","","Total Invoice:",u.totalInvoice]],a.format.font.bold=!0,s.getRange(`E${r}`).numberFormat=[[n()]],s.getRange(`A1:E${r}`).format.autofitColumns()}else s.getRange("A1:E7").format.autofitColumns();s.activate(),await a.sync()})}(t,k.poFilename,e);const r=t.totals;return`Re-invoice created.\n\nLines: ${r.lineCount}\nCorrected total: ${o(r.totalInvoice)}\nPrice corrections: ${e}\n\nThe ReInvoice sheet has been activated. Yellow-highlighted rows indicate price corrections.`}()}catch(t){return`Error: ${t.message}`}}),Office.actions.associate("DraftExceptionEmail",async()=>{try{return await async function(){if(!k.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=function(t,e){const n=function(t){if(!t)return"Unknown";const e=t.replace(/\.[^.]+$/,""),n=e.match(/(?:PO[-_ ]?)(\d+[-\w]*)/i);return n?`PO-${n[1]}`:e}(e),{summary:r,rows:a}=t,i=a.filter(t=>"Exception"===t.status||"Not in ERP"===t.status||"Not in PO"===t.status),c=i.slice(0,3),s=`PO ${n} — Reconciliation: ${r.exceptions} exception${1!==r.exceptions?"s":""} found`,l=c.map(t=>"Not in ERP"===t.status?`  - SKU ${t.sku}: Not found in ERP`:"Not in PO"===t.status?`  - SKU ${t.sku}: In ERP but not on PO`:`  - SKU ${t.sku}: PO ${o(t.poPrice)} vs ERP ${o(t.erpPrice)} (diff: ${o(t.diff)})`);return{subject:s,body:`Hi Team,\n\nPO reconciliation for ${n} has been completed. Please see the summary below:\n\n  Total line items:    ${r.total}\n  Perfect matches:     ${r.matches}\n  Within tolerance:    ${r.tolerances}\n  Exceptions:          ${r.exceptions}\n  Total $ exposure:    ${o(r.exposure)}\n\n${r.exceptions>0?`Top exceptions:\n${l.join("\n")}\n${i.length>3?`  ... and ${i.length-3} more\n`:""}`:"All items matched within tolerance."}\nFull reconciliation details are in the Recon sheet attached to this workbook.\n${r.exceptions>0?"\nCredit note and corrected re-invoice sheets have been generated in this workbook.\n":""}\nPlease review and advise on next steps.\n\nBest regards`}}(k.results,k.poFilename);return`Subject: ${t.subject}\n\n${t.body}`}()}catch(t){return`Error: ${t.message}`}})})();