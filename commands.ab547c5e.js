(()=>{"use strict";const e={GBP:{locale:"en-GB",currency:"GBP",format:"£#,##0.00"},USD:{locale:"en-US",currency:"USD",format:"$#,##0.00"},EUR:{locale:"de-DE",currency:"EUR",format:"€#,##0.00"}};let t="GBP";function n(n){e[n]&&(t=n)}function o(){return e[t].format}function r(n){if(null==n)return"—";const o="number"==typeof n?n:parseFloat(n);if(isNaN(o))return"—";const r=e[t];return new Intl.NumberFormat(r.locale,{style:"currency",currency:r.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}function a(e){if(null==e||""===e)return null;if("number"==typeof e)return isNaN(e)?null:e;const t=String(e).replace(/[$£€,\s]/g,"").trim();if(""===t)return null;const n=t.match(/^\((.+)\)$/);if(n){const e=parseFloat(n[1]);return isNaN(e)?null:-e}const o=parseFloat(t);return isNaN(o)?null:o}function i(e,t){const n=[];for(const[o,r]of t)o.startsWith(e)&&o!==e&&n.push({sku:o,entry:r});return n}function s(e){return String(e).trim().toUpperCase()}function l(e,t,n){for(const o of t)if(s(o[n])===e)return o[n];return e}function c(e){return Math.round(100*e)/100}const u=["sku","item number","product code","part number","item no","item #","material","product id","article","upc","ordered item","item"],f=["price","unit price","cost","amount","unit cost","net price","each","rate","ext price"],m=["product name","description","item description","product description","name","item name","product"],d=["qty","quantity","order qty","ordered qty","unit qty","units","ordered","order quantity","pcs","ea"];function g(e){return{sku:p(e,u),price:p(e,f),name:p(e,m),qty:p(e,d)}}function p(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const h="#1F4E79",w=["Status","SKU","Product Name","ERP $","PO $","Difference","% Diff","Action"];function y(e){return Math.round(100*e)/100}const $="#1F4E79",P="#FFFFFF",R="#A4262C";function k(e){const t=new Date;return`${e}_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const b=["delivery date","required date","ship date","due date","date required","req date","del date","arrival date","need by","need date","eta"],E=["po number","po no","po ref","po reference","purchase order","order number","order no","order ref","customer po","po#","order #"],O=["customer","customer name","sold to","bill to","buyer","account","account name","company","ship to name"],F=["uom","unit of measure","unit","pack size","pack","case size","inner","outer"],v=["line total","total","ext amount","extended","line amount","net amount","value","ext price"];function C(e){return{...g(e),deliveryDate:x(e,b),poRef:x(e,E),customer:x(e,O),uom:x(e,F),lineTotal:x(e,v)}}function S(e){return null==e?"":String(e).trim()}function N(e){if(null==e||""===e)return null;const t=String(e).trim(),n=new Date(t);if(!isNaN(n.getTime()))return n.toISOString().split("T")[0];const o=t.match(/^(\d{1,2})[/\-.](\d{1,2})[/\-.](\d{2,4})$/);if(o){const e=o[1].padStart(2,"0"),t=o[2].padStart(2,"0");let n=o[3];return 2===n.length&&(n="20"+n),`${n}-${t}-${e}`}return t}function x(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const A="#1F4E79",D="#FFFFFF",T=["#","SKU","Product Name","Qty","Unit Price","UOM","Line Total","Delivery Date","Status"],q={results:null,poFilename:""};async function I(e){const t=e?JSON.parse(e):{},u=t.tolerance??.02;let f,m,d,p;n(t.currency??"GBP"),await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.load("values"),await e.sync();const n=t.values;if(!n||n.length<2)throw new Error("Please select ERP data in Excel first (header row + data rows).");const o=n[0].map(e=>String(e).trim()).filter(Boolean),r=n.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return o.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(m=g(o),!m.sku||!m.price)throw new Error(`Could not detect SKU and Price columns in ERP data. Found headers: ${o.join(", ")}`);f={headers:o,rows:r}}),await Excel.run(async e=>{let t;const n=e.workbook.worksheets.getItemOrNullObject("PO");await e.sync(),t=n.isNullObject?e.workbook.worksheets.getFirst():n;const o=t.getUsedRange();o.load("values"),await e.sync();const r=o.values;if(!r||r.length<2)throw new Error("PO sheet has no data. Upload a PO file first.");const a=r[0].map(e=>String(e).trim()).filter(Boolean),i=r.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return a.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(p=g(a),!p.sku||!p.price)throw new Error(`Could not detect SKU and Price columns in PO data. Found headers: ${a.join(", ")}`);d={headers:a,rows:i},q.poFilename=t.name});const y=function({poData:e,poColumns:t,erpData:n,erpColumns:o,tolerance:r}){const u=new Map,f=new Set;for(const e of n.rows){const t=e[o.sku];if(!t)continue;const n=s(t);u.has(n)&&f.add(n),u.set(n,{price:a(e[o.price]),name:o.name&&e[o.name]||"",qty:o.qty&&a(e[o.qty])||1,originalRow:e,matched:!1})}const m=new Map;for(const n of e.rows){const e=n[t.sku];if(!e)continue;const o=s(e);m.set(o,(m.get(o)||0)+1)}const d=new Set;for(const[e,t]of m)t>1&&d.add(e);const g=[];let p=0,h=0,w=0,y=0,$=0;for(const m of e.rows){const e=m[t.sku];if(!e)continue;const P=s(e),R=a(m[t.price]),k=t.name&&m[t.name]||"",b=t.qty&&a(m[t.qty])||1,E=d.has(P)||f.has(P);if(null===R){$++,g.push({status:"Warning",sku:e,name:k,erpPrice:null,poPrice:null,diff:null,pctDiff:null,action:"Non-numeric price — skipped",duplicate:E,poQty:b,erpQty:null,lineTotal:null});continue}let O=u.get(P),F="exact";if(!O){const t=i(P,u);if(1===t.length)O=t[0].entry,F="prefix";else if(t.length>1){const n=t.map(e=>e.sku).join(", ");$++,g.push({status:"Warning",sku:e,name:k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:`Multiple ERP matches: ${n}`,duplicate:E,poQty:b,erpQty:null,lineTotal:c(R*b)});continue}}if(!O){w++,g.push({status:"Not in ERP",sku:e,name:k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Review — SKU not found in ERP",duplicate:E,poQty:b,erpQty:null,lineTotal:c(R*b)});continue}if(O.matched=!0,null===O.price){$++,g.push({status:"Warning",sku:e,name:O.name||k,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Non-numeric ERP price",duplicate:E,poQty:b,erpQty:O.qty,lineTotal:c(R*b)});continue}const v=c(R-O.price),C=Math.abs(v),S=0!==O.price?c(v/O.price*100):0!==v?100:0;let N,x;0===C?(N="Match",x="OK",p++):C<=r?(N="Tolerance",x="OK — within tolerance",h++):(N="Exception",x="Review pricing",w++,y+=C),g.push({status:N,sku:e,erpSku:"prefix"===F?l(i(P,u)[0].sku,n.rows,o.sku):null,name:O.name||k,erpPrice:O.price,poPrice:R,diff:v,pctDiff:S,action:"prefix"===F&&"OK"===x?"OK (prefix match)":x,duplicate:E,poQty:b,erpQty:O.qty,lineTotal:c(R*b)})}for(const[e,t]of u)t.matched||g.push({status:"Not in PO",sku:l(e,n.rows,o.sku),name:t.name,erpPrice:t.price,poPrice:null,diff:null,pctDiff:null,action:"Review — SKU not in PO",duplicate:f.has(e),poQty:null,erpQty:t.qty,lineTotal:null});const P={Exception:0,"Not in ERP":1,"Not in PO":2,Warning:3,Tolerance:4,Match:5};return g.sort((e,t)=>{const n=P[e.status]??99,o=P[t.status]??99;if(n!==o)return n-o;const r=null!=e.diff?Math.abs(e.diff):0;return(null!=t.diff?Math.abs(t.diff):0)-r}),{summary:{total:g.length,matches:p,tolerances:h,exceptions:w,exposure:c(y),warnings:$,timestamp:(new Date).toISOString()},rows:g}}({poData:d,poColumns:p,erpData:f,erpColumns:m,tolerance:u});q.results=y,await async function(e,t){await Excel.run(async n=>{const a=function(){const e=new Date;return`Recon_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),l=[["PO Reconciliation Summary",""],["Total Line Items",e.summary.total],["Perfect Matches",e.summary.matches],["Within Tolerance",e.summary.tolerances],["Exceptions",e.summary.exceptions],["Total $ Exposure",r(e.summary.exposure)],["Tolerance Used",r(t)],["Timestamp",(new Date).toLocaleString()]];s.getRange("A1:B8").values=l;const c=s.getRange("A1:B1");c.merge(),c.format.font.bold=!0,c.format.font.size=14,c.format.font.color=h,s.getRange("A2:A8").format.font.bold=!0;const u=s.getRange("A5:B5");u.format.font.color="#A4262C",u.format.font.bold=!0;const f=s.getRange("A10:H10");if(f.values=[w],f.format.font.bold=!0,f.format.font.color="#FFFFFF",f.format.fill.color=h,s.freezePanes.freezeRows(10),e.rows.length>0){const t=e.rows.map(e=>[e.duplicate?`${e.status} (DUP)`:e.status,e.erpSku?`${e.sku} → ${e.erpSku}`:e.sku,e.name||"",null!=e.erpPrice?e.erpPrice:"",null!=e.poPrice?e.poPrice:"",null!=e.diff?e.diff:"",null!=e.pctDiff?`${e.pctDiff}%`:"",e.action]),n=11,r=n+t.length-1;s.getRange(`A${n}:H${r}`).values=t;for(let t=0;t<e.rows.length;t++){const o=s.getRange(`A${n+t}:H${n+t}`),r=e.rows[t].status;"Exception"===r||"Not in ERP"===r||"Not in PO"===r?o.format.fill.color="#FFC7CE":"Tolerance"===r?o.format.fill.color="#FFEB9C":"Match"===r?o.format.fill.color="#C6EFCE":"Warning"===r&&(o.format.fill.color="#F2F2F2")}const a=["D","E","F"];for(const e of a)s.getRange(`${e}${n}:${e}${r}`).numberFormat=[[o()]]}s.getRange(`A1:H${10+e.rows.length}`).format.autofitColumns(),s.activate(),await n.sync()})}(y,u);const $=y.summary;return`Reconciliation complete.\n\nTotal items: ${$.total}\nPerfect matches: ${$.matches}\nWithin tolerance: ${$.tolerances}\nExceptions: ${$.exceptions}\nWarnings: ${$.warnings}\nTotal exposure: ${r($.exposure)}\n\nResults sheet created with color-coded status rows.`}Office.onReady(()=>{}),Office.actions.associate("ExtractPOData",async e=>{try{return await async function(e){const t=e?JSON.parse(e):{},i=t.sheetName||null;let s;n(t.currency??"GBP"),await Excel.run(async e=>{let t;if(i){if(t=e.workbook.worksheets.getItemOrNullObject(i),await e.sync(),t.isNullObject)throw new Error(`Sheet "${i}" not found. Available sheets can be listed.`)}else t=e.workbook.worksheets.getActiveWorksheet();const n=t.getUsedRange();n.load("values"),t.load("name"),await e.sync();const o=n.values;if(!o||o.length<2)throw new Error("Sheet has no data. Open or paste PO data first.");let r=0,a=0;const l=["sku","item","product","price","cost","qty","quantity","description","name","unit","total","amount","date","order"];for(let e=0;e<Math.min(o.length,15);e++){let t=0;for(const n of o[e]){const e=String(n||"").toLowerCase().trim();if(!(e.length>40))for(const n of l)if(e.includes(n)){t++;break}}t>a&&(a=t,r=e)}const c=o[r].map(e=>String(e??"").trim()).filter(Boolean),u=o.slice(r+1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return c.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});s={headers:c,rows:u},q.poFilename=t.name});const l=C(s.headers),c=function(e,t){const n=t||C(e.headers);if(!n.sku)throw new Error("Cannot find SKU column. Available headers: "+e.headers.join(", "));const o=[],r=[];let i=null,s=null;for(let t=0;t<e.rows.length;t++){const l=e.rows[t],c=t+1,u=S(l[n.sku]);if(!u){r.push({line:c,field:"SKU",message:"Empty SKU — row skipped"});continue}const f=n.price?l[n.price]:null,m=null!=f?a(f):null;n.price&&null===m&&f&&r.push({line:c,field:"Price",message:`Non-numeric price: "${f}"`});const d=n.qty?l[n.qty]:null,g=null!=d?a(d):null;n.qty&&null===g&&d&&r.push({line:c,field:"Qty",message:`Non-numeric quantity: "${d}"`}),null!==g&&g<=0&&r.push({line:c,field:"Qty",message:`Zero or negative quantity: ${g}`});const p=n.name?S(l[n.name]):"",h=n.deliveryDate?N(l[n.deliveryDate]):null,w=n.uom?S(l[n.uom]):"",y=n.lineTotal?l[n.lineTotal]:null;let $=null!=y?a(y):null;if(null===$&&null!==m&&null!==g&&($=Math.round(m*g*100)/100),null!==$&&null!==m&&null!==g){const e=Math.round(m*g*100)/100;Math.abs($-e)>.02&&r.push({line:c,field:"Line Total",message:`Mismatch: ${$} vs expected ${e} (price × qty)`})}if(!i&&n.poRef){const e=S(l[n.poRef]);e&&(i=e)}if(!s&&n.customer){const e=S(l[n.customer]);e&&(s=e)}o.push({lineNum:c,sku:u,name:p,qty:g??1,price:m??0,uom:w,lineTotal:$??0,deliveryDate:h||"",status:"Pending"})}const l=o.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(l.length>=5){const e=l[Math.floor(l.length/2)],t=3*e;for(const n of o)n.qty>t&&r.push({line:n.lineNum,field:"Qty",message:`Unusually large quantity: ${n.qty} (median: ${e})`})}const c=o.reduce((e,t)=>e+t.lineTotal,0);return{stagingRows:o,metadata:{lineCount:o.length,totalValue:Math.round(100*c)/100,poRef:i||"Unknown",customer:s||"Unknown",detectedFields:Object.entries(n).filter(([,e])=>null!==e).map(([e])=>e),warningCount:r.length,extractedAt:(new Date).toISOString()},warnings:r}}(s,l);await async function(e){const{stagingRows:t,metadata:n,warnings:a}=e;await Excel.run(async e=>{const i=`Staging_${(n.poRef||"PO").replace(/[^a-zA-Z0-9-_]/g,"").slice(0,20)}`,s=e.workbook.worksheets.getItemOrNullObject(i);await e.sync(),s.isNullObject||(s.delete(),await e.sync());const l=e.workbook.worksheets.add(i),c=[["PO Staging Sheet",""],["PO Reference",n.poRef],["Customer",n.customer],["Line Items",n.lineCount],["Total Value",r(n.totalValue)],["Warnings",n.warningCount],["Extracted",(new Date).toLocaleString()]];l.getRange("A1:B7").values=c;const u=l.getRange("A1:B1");if(u.merge(),u.format.font.bold=!0,u.format.font.size=14,u.format.font.color=A,l.getRange("A2:A7").format.font.bold=!0,n.warningCount>0){const e=l.getRange("B6");e.format.font.color="#A4262C",e.format.font.bold=!0}const f=l.getRange("A9:I9");if(f.values=[T],f.format.font.bold=!0,f.format.font.color=D,f.format.fill.color=A,l.freezePanes.freezeRows(9),t.length>0){const e=new Map;for(const t of a)e.has(t.line)||e.set(t.line,[]),e.get(t.line).push(`${t.field}: ${t.message}`);const r=t.map(t=>[t.lineNum,t.sku,t.name,t.qty,t.price,t.uom,t.lineTotal,t.deliveryDate,e.has(t.lineNum)?"Review":t.status]),i=10,s=i+r.length-1;l.getRange(`A${i}:I${s}`).values=r;for(const e of["E","G"])l.getRange(`${e}${i}:${e}${s}`).numberFormat=[[o()]];l.getRange(`H${i}:H${s}`).numberFormat=[["yyyy-mm-dd"]];for(let n=0;n<t.length;n++){const o=l.getRange(`A${i+n}:I${i+n}`);e.has(t[n].lineNum)?(o.format.fill.color="#FFEB9C",l.getRange(`I${i+n}`).note=e.get(t[n].lineNum).join("\n")):o.format.fill.color="#E2EFDA"}const c=s+1,u=l.getRange(`A${c}:I${c}`);u.values=[["","","",t.reduce((e,t)=>e+t.qty,0),"","",n.totalValue,"",`${t.length} lines`]],u.format.font.bold=!0,l.getRange(`G${c}`).numberFormat=[[o()]],l.getRange(`A1:I${c}`).format.autofitColumns()}else l.getRange("A1:I9").format.autofitColumns();if(a.length>0){const t=i+"_Warnings",n=e.workbook.worksheets.getItemOrNullObject(t);await e.sync(),n.isNullObject||(n.delete(),await e.sync());const o=e.workbook.worksheets.add(t),r=["Line","Field","Warning"],s=o.getRange("A1:C1");s.values=[r],s.format.font.bold=!0,s.format.font.color=D,s.format.fill.color="#A4262C";const l=a.map(e=>[e.line,e.field,e.message]);o.getRange(`A2:C${1+l.length}`).values=l,o.getRange(`A1:C${1+l.length}`).format.autofitColumns()}l.activate(),await e.sync()})}(c),q.lastExtraction=c;const u=c.metadata,f=u.detectedFields.join(", ");let m="PO data extracted and staging sheet created.\n\n";if(m+=`PO Reference: ${u.poRef}\n`,m+=`Customer: ${u.customer}\n`,m+=`Line items: ${u.lineCount}\n`,m+=`Total value: ${r(u.totalValue)}\n`,m+=`Detected fields: ${f}\n`,u.warningCount>0){m+=`\nWarnings: ${u.warningCount}\n`;const e=c.warnings.slice(0,5);for(const t of e)m+=`  Line ${t.line}: ${t.field} — ${t.message}\n`;c.warnings.length>5&&(m+=`  ... and ${c.warnings.length-5} more (see Warnings sheet)\n`),m+="\nYellow-highlighted rows need review. Check cell notes for details."}else m+="\nNo warnings — all data looks clean.";return m}(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("ReconcilePO",async e=>{try{return await I(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateCreditNote",async()=>{try{return await async function(){if(!q.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice)continue;const e=o.poQty||1,r=y(o.poPrice*e),a=y(-r);t.push({sku:o.sku,name:o.name||"",qty:e,originalPrice:o.poPrice,lineTotal:r,creditAmount:a}),n=y(n+a)}return{creditRows:t,totals:{lineCount:t.length,totalCredit:n}}}(q.results);await async function(e,t){await Excel.run(async n=>{const a=k("CreditNote"),i=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),i.isNullObject||(i.delete(),await n.sync());const s=n.workbook.worksheets.add(a),{creditRows:l,totals:c}=e,u=[["Credit Note",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Total Lines",c.lineCount],["Total Credit",r(c.totalCredit)]];s.getRange("A1:B5").values=u;const f=s.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=$,s.getRange("A2:A5").format.font.bold=!0;const m=s.getRange("A5:B5");m.format.font.color=R,m.format.font.bold=!0;const d=s.getRange("A7:F7");if(d.values=[["SKU","Product Name","Qty","Original Price","Line Total","Credit Amount"]],d.format.font.bold=!0,d.format.font.color=P,d.format.fill.color=$,s.freezePanes.freezeRows(7),l.length>0){const e=l.map(e=>[e.sku,e.name,e.qty,e.originalPrice,e.lineTotal,e.creditAmount]),t=8,n=t+e.length-1;s.getRange(`A${t}:F${n}`).values=e;for(const e of["D","E","F"])s.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];s.getRange(`F${t}:F${n}`).format.font.color=R;const r=n+1,a=s.getRange(`A${r}:F${r}`);a.values=[["","","","","Total Credit:",c.totalCredit]],a.format.font.bold=!0;const i=s.getRange(`F${r}`);i.numberFormat=[[o()]],i.format.font.color=R,s.getRange(`A1:F${r}`).format.autofitColumns()}else s.getRange("A1:F7").format.autofitColumns();s.activate(),await n.sync()})}(e,q.poFilename);const t=e.totals;return`Credit note created.\n\nLines: ${t.lineCount}\nTotal credit: ${r(t.totalCredit)}\n\nThe CreditNote sheet has been activated.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateReInvoice",async()=>{try{return await async function(){if(!q.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Not in PO"===o.status)continue;if(null==o.poPrice&&null==o.erpPrice)continue;const e=o.poQty||1,r=null!=o.erpPrice?o.erpPrice:o.poPrice,a=y(r*e),i=null!=o.erpPrice&&null!=o.poPrice&&o.erpPrice!==o.poPrice;t.push({sku:o.sku,name:o.name||"",qty:e,correctedPrice:r,lineTotal:a,priceChanged:i}),n=y(n+a)}return{invoiceRows:t,totals:{lineCount:t.length,totalInvoice:n}}}(q.results),t=q.results.summary.exceptions;await async function(e,t,n){await Excel.run(async a=>{const i=k("ReInvoice"),s=a.workbook.worksheets.getItemOrNullObject(i);await a.sync(),s.isNullObject||(s.delete(),await a.sync());const l=a.workbook.worksheets.add(i),{invoiceRows:c,totals:u}=e,f=[["Corrected Re-Invoice",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"—"],["Corrected Total",r(u.totalInvoice)],["Price Corrections",n]];l.getRange("A1:B5").values=f;const m=l.getRange("A1:B1");m.merge(),m.format.font.bold=!0,m.format.font.size=14,m.format.font.color=$,l.getRange("A2:A5").format.font.bold=!0;const d=l.getRange("A7:E7");if(d.values=[["SKU","Product Name","Qty","Corrected Price","Line Total"]],d.format.font.bold=!0,d.format.font.color=P,d.format.fill.color=$,l.freezePanes.freezeRows(7),c.length>0){const e=c.map(e=>[e.sku,e.name,e.qty,e.correctedPrice,e.lineTotal]),t=8,n=t+e.length-1;l.getRange(`A${t}:E${n}`).values=e;for(const e of["D","E"])l.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<c.length;e++)c[e].priceChanged&&(l.getRange(`A${t+e}:E${t+e}`).format.fill.color="#FFEB9C");const r=n+1,a=l.getRange(`A${r}:E${r}`);a.values=[["","","","Total Invoice:",u.totalInvoice]],a.format.font.bold=!0,l.getRange(`E${r}`).numberFormat=[[o()]],l.getRange(`A1:E${r}`).format.autofitColumns()}else l.getRange("A1:E7").format.autofitColumns();l.activate(),await a.sync()})}(e,q.poFilename,t);const n=e.totals;return`Re-invoice created.\n\nLines: ${n.lineCount}\nCorrected total: ${r(n.totalInvoice)}\nPrice corrections: ${t}\n\nThe ReInvoice sheet has been activated. Yellow-highlighted rows indicate price corrections.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("DraftExceptionEmail",async()=>{try{return await async function(){if(!q.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e,t){const n=function(e){if(!e)return"Unknown";const t=e.replace(/\.[^.]+$/,""),n=t.match(/(?:PO[-_ ]?)(\d+[-\w]*)/i);return n?`PO-${n[1]}`:t}(t),{summary:o,rows:a}=e,i=a.filter(e=>"Exception"===e.status||"Not in ERP"===e.status||"Not in PO"===e.status),s=i.slice(0,3),l=`PO ${n} — Reconciliation: ${o.exceptions} exception${1!==o.exceptions?"s":""} found`,c=s.map(e=>"Not in ERP"===e.status?`  - SKU ${e.sku}: Not found in ERP`:"Not in PO"===e.status?`  - SKU ${e.sku}: In ERP but not on PO`:`  - SKU ${e.sku}: PO ${r(e.poPrice)} vs ERP ${r(e.erpPrice)} (diff: ${r(e.diff)})`);return{subject:l,body:`Hi Team,\n\nPO reconciliation for ${n} has been completed. Please see the summary below:\n\n  Total line items:    ${o.total}\n  Perfect matches:     ${o.matches}\n  Within tolerance:    ${o.tolerances}\n  Exceptions:          ${o.exceptions}\n  Total $ exposure:    ${r(o.exposure)}\n\n${o.exceptions>0?`Top exceptions:\n${c.join("\n")}\n${i.length>3?`  ... and ${i.length-3} more\n`:""}`:"All items matched within tolerance."}\nFull reconciliation details are in the Recon sheet attached to this workbook.\n${o.exceptions>0?"\nCredit note and corrected re-invoice sheets have been generated in this workbook.\n":""}\nPlease review and advise on next steps.\n\nBest regards`}}(q.results,q.poFilename);return`Subject: ${e.subject}\n\n${e.body}`}()}catch(e){return`Error: ${e.message}`}})})();