(()=>{"use strict";const e={GBP:{locale:"en-GB",currency:"GBP",format:"Â£#,##0.00"},USD:{locale:"en-US",currency:"USD",format:"$#,##0.00"},EUR:{locale:"de-DE",currency:"EUR",format:"â‚¬#,##0.00"}};let t="GBP";function n(n){e[n]&&(t=n)}function o(){return e[t].format}function r(n){if(null==n)return"â€”";const o="number"==typeof n?n:parseFloat(n);if(isNaN(o))return"â€”";const r=e[t];return new Intl.NumberFormat(r.locale,{style:"currency",currency:r.currency,minimumFractionDigits:2,maximumFractionDigits:2}).format(o)}function a(e){if(null==e||""===e)return null;if("number"==typeof e)return isNaN(e)?null:e;const t=String(e).replace(/[$Â£â‚¬,\s]/g,"").trim();if(""===t)return null;const n=t.match(/^\((.+)\)$/);if(n){const e=parseFloat(n[1]);return isNaN(e)?null:-e}const o=parseFloat(t);return isNaN(o)?null:o}function s(e,t){const n=[];for(const[o,r]of t)o.startsWith(e)&&o!==e&&n.push({sku:o,entry:r});return n}function i(e){return String(e).trim().toUpperCase()}function c(e,t,n){for(const o of t)if(i(o[n])===e)return o[n];return e}function l(e){return Math.round(100*e)/100}const u=["sku","item number","product code","part number","item no","item #","material","product id","article","upc","ordered item","item"],f=["price","unit price","cost","amount","unit cost","net price","each","rate","ext price"],g=["product name","description","item description","product description","name","item name","product"],d=["qty","quantity","order qty","ordered qty","unit qty","units","ordered","order quantity","pcs","ea"];function m(e){return{sku:p(e,u),price:p(e,f),name:p(e,g),qty:p(e,d)}}function p(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const h="#1F4E79",y=["Status","SKU","Product Name","ERP $","PO $","Difference","% Diff","Action"];function $(e){return Math.round(100*e)/100}const w="#1F4E79",P="#FFFFFF",R="#A4262C";function v(e){const t=new Date;return`${e}_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const k=["delivery date","required date","ship date","due date","date required","req date","del date","arrival date","need by","need date","eta"],b=["po number","po no","po ref","po reference","purchase order","order number","order no","order ref","customer po","po#","order #"],x=["customer","customer name","sold to","bill to","buyer","account","account name","company","ship to name"],E=["uom","unit of measure","unit","pack size","pack","case size","inner","outer"],S=["line total","total","ext amount","extended","line amount","net amount","value","ext price"];function C(e){return{...m(e),deliveryDate:N(e,k),poRef:N(e,b),customer:N(e,x),uom:N(e,E),lineTotal:N(e,S)}}function F(e){return null==e?"":String(e).trim()}function O(e){if(null==e||""===e)return null;const t=String(e).trim(),n=new Date(t);if(!isNaN(n.getTime()))return n.toISOString().split("T")[0];const o=t.match(/^(\d{1,2})[/\-.](\d{1,2})[/\-.](\d{2,4})$/);if(o){const e=o[1].padStart(2,"0"),t=o[2].padStart(2,"0");let n=o[3];return 2===n.length&&(n="20"+n),`${n}-${t}-${e}`}return t}function N(e,t){const n=e.map(e=>e.toLowerCase().trim());for(const o of t){const t=n.indexOf(o);if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>e.includes(o));if(-1!==t)return e[t]}for(const o of t){const t=n.findIndex(e=>o.includes(e)&&e.length>=3);if(-1!==t)return e[t]}return null}const D="#1F4E79",A="#FFFFFF",T=["#","SKU","Product Name","Qty","Unit Price","UOM","Line Total","Delivery Date","Status"];function I(e){const t=new Map;for(const n of e){const e=n.sku.toUpperCase().trim();t.has(e)||t.set(e,[]),t.get(e).push(n.lineNum)}const n=[];for(const[e,o]of t)o.length>1&&n.push({severity:"warning",rule:"duplicate-sku",field:"SKU",lines:o,message:`Duplicate SKU "${e}" on lines ${o.join(", ")}`});return n}function U(e){const t=e.filter(e=>0===e.price||null===e.price);return 0===t.length?[]:t.length===e.length?[{severity:"error",rule:"no-prices",message:"No rows have a valid price. Check column detection."}]:t.map(e=>({severity:"error",rule:"missing-price",field:"Price",lines:[e.lineNum],message:`Line ${e.lineNum} (${e.sku}): missing or zero price`}))}function M(e){const t=[];for(const n of e)n.qty<=0&&t.push({severity:"error",rule:"invalid-qty",field:"Qty",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): quantity is ${n.qty}`});return t}function B(e){const t=[];for(const n of e)n.price>0&&(n.price<.01||n.price>9999.99)&&t.push({severity:"warning",rule:"price-range",field:"Price",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): price ${n.price} outside expected range (0.01â€“9999.99)`});return t}function q(e){const t=e.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(t.length<5)return[];const n=t[Math.floor(t.length/2)],o=5*n,r=[];for(const t of e)t.qty>o&&r.push({severity:"warning",rule:"qty-outlier",field:"Qty",lines:[t.lineNum],message:`Line ${t.lineNum} (${t.sku}): quantity ${t.qty} is unusually large (median: ${n})`});return r}function K(e){const t=[];for(const n of e)if(n.lineTotal>0&&n.price>0&&n.qty>0){const e=Math.round(n.price*n.qty*100)/100;Math.abs(n.lineTotal-e)>.02&&t.push({severity:"warning",rule:"line-total-mismatch",field:"Line Total",lines:[n.lineNum],message:`Line ${n.lineNum} (${n.sku}): total ${n.lineTotal} â‰  price Ã— qty (${e})`})}return t}function L(e){const t=e.filter(e=>!e.name||""===e.name.trim());return 0===t.length?[]:e.some(e=>e.name&&e.name.trim())?[{severity:"info",rule:"missing-names",lines:t.map(e=>e.lineNum),message:`${t.length} row(s) missing product name`}]:[{severity:"info",rule:"no-names",message:"No product names detected â€” consider adding a Description column."}]}function j(e){const t=e.map(e=>e.sku),n=t.filter(e=>/[a-zA-Z]/.test(e)),o=t.filter(e=>/^\d+$/.test(e));return n.length>0&&o.length>0&&o.length<=.3*e.length?[{severity:"info",rule:"mixed-sku-format",message:`Mixed SKU formats: ${n.length} alphanumeric, ${o.length} numeric-only. This may affect ERP matching.`}]:[]}const z="Ready",W="Review",G="Hold";function Q(e){return Math.round(100*e)/100}const H="#1F4E79",V="#E2EFDA",Y="#FFEB9C",_="#FFC7CE";function J(e){if(!e||0===e.length)return{skuAnalysis:new Map,topMovers:[],watchList:[],metrics:{totalSKUs:0,totalRecords:0,totalRuns:0,avgDrift:0,exceptionRate:0,anomalyCount:0,trendingUp:0,trendingDown:0,stable:0,insufficientData:0}};const t=new Map;for(const n of e){const e=X(n.sku);t.has(e)||t.set(e,[]),t.get(e).push(n)}const n=new Map;for(const[e,o]of t){const t=[...o].sort((e,t)=>e.date.localeCompare(t.date));n.set(e,Z(t))}const o=[...n.entries()].filter(([,e])=>null!==e.lastChange&&e.dataPoints>=2).sort((e,t)=>Math.abs(t[1].lastChange)-Math.abs(e[1].lastChange)).slice(0,10).map(([e,t])=>({sku:e,name:t.name,lastChange:t.lastChange,lastChangePct:t.lastChangePct,direction:t.trend.direction,currentPrice:t.currentErpPrice,dataPoints:t.dataPoints})),r=[...n.entries()].filter(([,e])=>e.flags.length>0).sort((e,t)=>t[1].flags.length-e[1].flags.length||t[1].riskScore-e[1].riskScore).slice(0,15).map(([e,t])=>({sku:e,name:t.name,flags:t.flags,riskScore:t.riskScore,currentErpPrice:t.currentErpPrice,trend:t.trend.direction})),a=function(e,t){const n=t.size,o=e.length,r=new Set(e.map(e=>e.poRef+"|"+e.date)).size;let a=0,s=0,i=0,c=0,l=0,u=0,f=0;for(const[,e]of t)"up"===e.trend.direction?(i++,a+=e.trend.slopePct||0,s++):"down"===e.trend.direction?(c++,a+=e.trend.slopePct||0,s++):"stable"===e.trend.direction?(l++,s++):u++,e.anomaly&&f++;const g=s>0?ne(a/s):0,d=e.filter(e=>"Exception"===e.status).length;return{totalSKUs:n,totalRecords:o,totalRuns:r,avgDrift:g,exceptionRate:o>0?ne(d/o*100):0,anomalyCount:f,trendingUp:i,trendingDown:c,stable:l,insufficientData:u}}(e,n);return{skuAnalysis:n,topMovers:o,watchList:r,metrics:a}}function Z(e){const t=e[e.length-1],n=t.name||e.find(e=>e.name)?.name||"",o=e.filter(e=>null!=e.erpPrice).map(e=>({date:e.date,price:e.erpPrice})),r=o.length>0?o[o.length-1].price:t.poPrice,a=o.length>=2?function(e){const t=e.length;if(t<2)return{direction:"insufficient",slope:0,confidence:0};const n=e.map((e,t)=>t),o=e.map(e=>e.price),r=ee(n),a=ee(o);let s=0,i=0;for(let e=0;e<t;e++)s+=(n[e]-r)*(o[e]-a),i+=(n[e]-r)**2;const c=0!==i?s/i:0,l=n.map(e=>a+c*(e-r)),u=o.reduce((e,t,n)=>e+(t-l[n])**2,0),f=o.reduce((e,t)=>e+(t-a)**2,0),g=f>0?1-u/f:0,d=0!==a?c/a*100:0;let m;return m=Math.abs(d)<.5?"stable":c>0?"up":"down",{direction:m,slope:ne(c),slopePct:ne(d),confidence:ne(g)}}(o):{direction:"insufficient",slope:0,confidence:0};let s=null,i=null;if(o.length>=2){const e=o[o.length-2].price,t=o[o.length-1].price;s=ne(t-e),i=0!==e?ne((t-e)/e*100):0}const c=o.map(e=>e.price),l=c.length>=2?te(c):0;let u=!1;if(c.length>=3){const e=ee(c.slice(0,-1)),t=te(c.slice(0,-1));t>0&&(u=Math.abs((c[c.length-1]-e)/t)>2)}const f=e.filter(e=>"Exception"===e.status).length,g=e.length>0?ne(f/e.length*100):0,d=[];u&&d.push("Price anomaly"),"up"===a.direction&&a.confidence>.5&&d.push("Consistent price increase"),g>=50&&e.length>=2&&d.push("Frequent exceptions"),null!==i&&Math.abs(i)>10&&d.push("Large recent change (>"+Math.abs(i).toFixed(0)+"%)"),l>0&&r>0&&l/r>.1&&d.push("High volatility");let m=0;return u&&(m+=30),"up"===a.direction&&(m+=15),g>=50&&(m+=20),null!==i&&Math.abs(i)>5&&(m+=15),l>0&&r>0&&(m+=Math.min(20,l/r*200)),m=Math.min(100,Math.round(m)),{name:n,dataPoints:o.length,currentErpPrice:r,trend:a,lastChange:s,lastChangePct:i,volatility:ne(l),anomaly:u,exceptionRate:g,exceptionCount:f,flags:d,riskScore:m}}function X(e){return String(e).trim().toUpperCase()}function ee(e){return e.length>0?e.reduce((e,t)=>e+t,0)/e.length:0}function te(e){if(e.length<2)return 0;const t=ee(e),n=e.reduce((e,n)=>e+(n-t)**2,0)/(e.length-1);return Math.sqrt(n)}function ne(e){return Math.round(100*e)/100}const oe="PriceHistory",re=["Date","PO Ref","SKU","Product Name","PO Price","ERP Price","Diff","Status","Qty"];async function ae(){let e=[];return await Excel.run(async t=>{let n;try{n=t.workbook.worksheets.getItem(oe),n.load("name"),await t.sync()}catch{return}const o=n.getUsedRangeOrNullObject(!0);if(o.load(["values","rowCount"]),await t.sync(),o.isNullObject||o.rowCount<2)return;const r=o.values;for(let t=1;t<r.length;t++){const n=r[t];n[2]&&e.push({date:String(n[0]||""),poRef:String(n[1]||""),sku:String(n[2]||""),name:String(n[3]||""),poPrice:se(n[4]),erpPrice:se(n[5]),diff:se(n[6]),status:String(n[7]||""),poQty:se(n[8])||0})}}),e}function se(e){if(null==e||""===e)return null;const t=Number(e);return isNaN(t)?null:t}const ie="Dashboard",ce="#1f4e79",le="#ffffff",ue="#d6e4f0",fe="#FFC7CE",ge="#E2EFDA",de="#F2F2F2",me="#FFC7CE",pe="#FFEB9C",he={results:null,poFilename:""};async function ye(e){const t=e?JSON.parse(e):{},u=t.tolerance??.02;let f,g,d,p;n(t.currency??"GBP"),await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.load("values"),await e.sync();const n=t.values;if(!n||n.length<2)throw new Error("Please select ERP data in Excel first (header row + data rows).");const o=n[0].map(e=>String(e).trim()).filter(Boolean),r=n.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return o.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(g=m(o),!g.sku||!g.price)throw new Error(`Could not detect SKU and Price columns in ERP data. Found headers: ${o.join(", ")}`);f={headers:o,rows:r}}),await Excel.run(async e=>{let t;const n=e.workbook.worksheets.getItemOrNullObject("PO");await e.sync(),t=n.isNullObject?e.workbook.worksheets.getFirst():n;const o=t.getUsedRange();o.load("values"),await e.sync();const r=o.values;if(!r||r.length<2)throw new Error("PO sheet has no data. Upload a PO file first.");const a=r[0].map(e=>String(e).trim()).filter(Boolean),s=r.slice(1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return a.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});if(p=m(a),!p.sku||!p.price)throw new Error(`Could not detect SKU and Price columns in PO data. Found headers: ${a.join(", ")}`);d={headers:a,rows:s},he.poFilename=t.name});const $=function({poData:e,poColumns:t,erpData:n,erpColumns:o,tolerance:r}){const u=new Map,f=new Set;for(const e of n.rows){const t=e[o.sku];if(!t)continue;const n=i(t);u.has(n)&&f.add(n),u.set(n,{price:a(e[o.price]),name:o.name&&e[o.name]||"",qty:o.qty&&a(e[o.qty])||1,originalRow:e,matched:!1})}const g=new Map;for(const n of e.rows){const e=n[t.sku];if(!e)continue;const o=i(e);g.set(o,(g.get(o)||0)+1)}const d=new Set;for(const[e,t]of g)t>1&&d.add(e);const m=[];let p=0,h=0,y=0,$=0,w=0;for(const g of e.rows){const e=g[t.sku];if(!e)continue;const P=i(e),R=a(g[t.price]),v=t.name&&g[t.name]||"",k=t.qty&&a(g[t.qty])||1,b=d.has(P)||f.has(P);if(null===R){w++,m.push({status:"Warning",sku:e,name:v,erpPrice:null,poPrice:null,diff:null,pctDiff:null,action:"Non-numeric price â€” skipped",duplicate:b,poQty:k,erpQty:null,lineTotal:null});continue}let x=u.get(P),E="exact";if(!x){const t=s(P,u);if(1===t.length)x=t[0].entry,E="prefix";else if(t.length>1){const n=t.map(e=>e.sku).join(", ");w++,m.push({status:"Warning",sku:e,name:v,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:`Multiple ERP matches: ${n}`,duplicate:b,poQty:k,erpQty:null,lineTotal:l(R*k)});continue}}if(!x){y++,m.push({status:"Not in ERP",sku:e,name:v,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Review â€” SKU not found in ERP",duplicate:b,poQty:k,erpQty:null,lineTotal:l(R*k)});continue}if(x.matched=!0,null===x.price){w++,m.push({status:"Warning",sku:e,name:x.name||v,erpPrice:null,poPrice:R,diff:null,pctDiff:null,action:"Non-numeric ERP price",duplicate:b,poQty:k,erpQty:x.qty,lineTotal:l(R*k)});continue}const S=l(R-x.price),C=Math.abs(S),F=0!==x.price?l(S/x.price*100):0!==S?100:0;let O,N;0===C?(O="Match",N="OK",p++):C<=r?(O="Tolerance",N="OK â€” within tolerance",h++):(O="Exception",N="Review pricing",y++,$+=C),m.push({status:O,sku:e,erpSku:"prefix"===E?c(s(P,u)[0].sku,n.rows,o.sku):null,name:x.name||v,erpPrice:x.price,poPrice:R,diff:S,pctDiff:F,action:"prefix"===E&&"OK"===N?"OK (prefix match)":N,duplicate:b,poQty:k,erpQty:x.qty,lineTotal:l(R*k)})}for(const[e,t]of u)t.matched||m.push({status:"Not in PO",sku:c(e,n.rows,o.sku),name:t.name,erpPrice:t.price,poPrice:null,diff:null,pctDiff:null,action:"Review â€” SKU not in PO",duplicate:f.has(e),poQty:null,erpQty:t.qty,lineTotal:null});const P={Exception:0,"Not in ERP":1,"Not in PO":2,Warning:3,Tolerance:4,Match:5};return m.sort((e,t)=>{const n=P[e.status]??99,o=P[t.status]??99;if(n!==o)return n-o;const r=null!=e.diff?Math.abs(e.diff):0;return(null!=t.diff?Math.abs(t.diff):0)-r}),{summary:{total:m.length,matches:p,tolerances:h,exceptions:y,exposure:l($),warnings:w,timestamp:(new Date).toISOString()},rows:m}}({poData:d,poColumns:p,erpData:f,erpColumns:g,tolerance:u});he.results=$,await async function(e,t){await Excel.run(async n=>{const a=function(){const e=new Date;return`Recon_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),s=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),s.isNullObject||(s.delete(),await n.sync());const i=n.workbook.worksheets.add(a),c=[["PO Reconciliation Summary",""],["Total Line Items",e.summary.total],["Perfect Matches",e.summary.matches],["Within Tolerance",e.summary.tolerances],["Exceptions",e.summary.exceptions],["Total $ Exposure",r(e.summary.exposure)],["Tolerance Used",r(t)],["Timestamp",(new Date).toLocaleString()]];i.getRange("A1:B8").values=c;const l=i.getRange("A1:B1");l.merge(),l.format.font.bold=!0,l.format.font.size=14,l.format.font.color=h,i.getRange("A2:A8").format.font.bold=!0;const u=i.getRange("A5:B5");u.format.font.color="#A4262C",u.format.font.bold=!0;const f=i.getRange("A10:H10");if(f.values=[y],f.format.font.bold=!0,f.format.font.color="#FFFFFF",f.format.fill.color=h,i.freezePanes.freezeRows(10),e.rows.length>0){const t=e.rows.map(e=>[e.duplicate?`${e.status} (DUP)`:e.status,e.erpSku?`${e.sku} â†’ ${e.erpSku}`:e.sku,e.name||"",null!=e.erpPrice?e.erpPrice:"",null!=e.poPrice?e.poPrice:"",null!=e.diff?e.diff:"",null!=e.pctDiff?`${e.pctDiff}%`:"",e.action]),n=11,r=n+t.length-1;i.getRange(`A${n}:H${r}`).values=t;for(let t=0;t<e.rows.length;t++){const o=i.getRange(`A${n+t}:H${n+t}`),r=e.rows[t].status;"Exception"===r||"Not in ERP"===r||"Not in PO"===r?o.format.fill.color="#FFC7CE":"Tolerance"===r?o.format.fill.color="#FFEB9C":"Match"===r?o.format.fill.color="#C6EFCE":"Warning"===r&&(o.format.fill.color="#F2F2F2")}const a=["D","E","F"];for(const e of a)i.getRange(`${e}${n}:${e}${r}`).numberFormat=[[o()]]}i.getRange(`A1:H${10+e.rows.length}`).format.autofitColumns(),i.activate(),await n.sync()})}($,u);try{const e=(new Date).toISOString().slice(0,10),t=(w=$,P=he.poFilename,R=e,w.rows.filter(e=>null!=e.poPrice&&"Not in PO"!==e.status).map(e=>({date:R,poRef:P,sku:e.sku,name:e.name||"",poPrice:e.poPrice,erpPrice:e.erpPrice,diff:e.diff,status:e.status,poQty:e.poQty||0})));await async function(e){e&&0!==e.length&&await Excel.run(async t=>{const n=t.workbook.worksheets;let o;try{o=n.getItem(oe),o.load("name"),await t.sync()}catch{o=n.add(oe);const e=o.getRangeByIndexes(0,0,1,re.length);e.values=[re],e.format.font.bold=!0,e.format.font.color="#ffffff",e.format.fill.color="#1f4e79",e.format.horizontalAlignment="Center";const r=[100,130,110,220,85,85,75,85,60];for(let e=0;e<r.length;e++)o.getRangeByIndexes(0,e,1,1).format.columnWidth=r[e];await t.sync()}const r=o.getUsedRangeOrNullObject(!0);r.load("rowCount"),await t.sync();const a=r.isNullObject?1:r.rowCount,s=e.map(e=>[e.date,e.poRef,e.sku,e.name,e.poPrice,null!=e.erpPrice?e.erpPrice:"",null!=e.diff?e.diff:"",e.status,e.poQty||""]);o.getRangeByIndexes(a,0,s.length,re.length).values=s;const i="Â£#,##0.00";o.getRangeByIndexes(a,4,s.length,1).numberFormat=s.map(()=>[i]),o.getRangeByIndexes(a,5,s.length,1).numberFormat=s.map(()=>[i]),o.getRangeByIndexes(a,6,s.length,1).numberFormat=s.map(()=>[i]),await t.sync()})}(t)}catch{}var w,P,R;const v=$.summary;return`Reconciliation complete.\n\nTotal items: ${v.total}\nPerfect matches: ${v.matches}\nWithin tolerance: ${v.tolerances}\nExceptions: ${v.exceptions}\nWarnings: ${v.warnings}\nTotal exposure: ${r(v.exposure)}\n\nResults sheet created with color-coded status rows.`}async function $e(e){if(!he.results)return"No reconciliation results available. Please run ReconcilePO first.";const t=e?JSON.parse(e):{},n=function(e,t={}){const n=[];let o=0,r=0,a=0,s=0,i=0;for(const t of e.rows){if("Not in PO"===t.status)continue;if(null==t.poPrice&&null==t.erpPrice)continue;let e,c,l;switch(i++,t.status){case"Match":e=t.erpPrice??t.poPrice,c=z,l="";break;case"Tolerance":e=t.erpPrice??t.poPrice,c=z,l=`Within tolerance (diff: ${t.diff})`;break;case"Exception":e=t.erpPrice??t.poPrice,c=W,l=`Price exception: PO ${t.poPrice} vs ERP ${t.erpPrice} (diff: ${t.diff})`;break;case"Not in ERP":e=t.poPrice,c=G,l="SKU not found in ERP â€” verify item code";break;case"Warning":e=t.poPrice??0,c=G,l=t.action||"Data quality issue";break;default:e=t.erpPrice??t.poPrice??0,c=W,l=""}const u=t.poQty||1,f=Q(e*u);o=Q(o+f),c===z?r++:c===W?a++:s++,n.push({lineNum:i,sku:t.sku,erpSku:t.erpSku||"",name:t.name||"",qty:u,uom:"EA",entryPrice:e,lineTotal:f,status:c,notes:l})}return{entryRows:n,totals:{lineCount:n.length,totalValue:o,readyCount:r,reviewCount:a,holdCount:s},metadata:{poRef:t.poRef||"Unknown",customer:t.customer||"Unknown",deliveryDate:t.deliveryDate||"",generatedAt:(new Date).toISOString(),reconciliationSummary:{matches:e.summary.matches,tolerances:e.summary.tolerances,exceptions:e.summary.exceptions,exposure:e.summary.exposure}}}}(he.results,{poRef:he.poFilename,customer:t.customer||"",deliveryDate:t.deliveryDate||""});await async function(e){await Excel.run(async t=>{const n=function(){const e=new Date;return`ERPStaging_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),a=t.workbook.worksheets.getItemOrNullObject(n);await t.sync(),a.isNullObject||(a.delete(),await t.sync());const s=t.workbook.worksheets.add(n),{entryRows:i,totals:c,metadata:l}=e,u=[["ERP Staging Sheet",""],["PO Reference",l.poRef],["Customer",l.customer],["Delivery Date",l.deliveryDate||"â€”"],["Generated",(new Date).toLocaleDateString()],["Total Lines",c.lineCount],["Total Value",r(c.totalValue)],["Status",`${c.readyCount} ready, ${c.reviewCount} review, ${c.holdCount} hold`]];s.getRange("A1:B8").values=u;const f=s.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=H,s.getRange("A2:A8").format.font.bold=!0;const g=["Line","SKU","ERP SKU","Description","Qty","UOM","Unit Price","Line Total","Status","Notes"],d=g.length,m=String.fromCharCode(64+d),p=s.getRange(`A10:${m}10`);if(p.values=[g],p.format.font.bold=!0,p.format.font.color="#FFFFFF",p.format.fill.color=H,s.freezePanes.freezeRows(10),i.length>0){const e=i.map(e=>[e.lineNum,e.sku,e.erpSku,e.name,e.qty,e.uom,e.entryPrice,e.lineTotal,e.status,e.notes]),t=11,n=t+e.length-1;s.getRange(`A${t}:${m}${n}`).values=e;for(const e of["G","H"])s.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];for(let e=0;e<i.length;e++){const n=s.getRange(`A${t+e}:${m}${t+e}`);switch(i[e].status){case"Ready":n.format.fill.color=V;break;case"Review":n.format.fill.color=Y;break;case"Hold":n.format.fill.color=_}}const r=n+2,a=s.getRange(`A${r}:${m}${r}`);a.values=[["","","","","","","Total:",c.totalValue,"",""]],a.format.font.bold=!0,s.getRange(`H${r}`).numberFormat=[[o()]];const l=r+2;s.getRange(`A${l}`).values=[["Legend:"]],s.getRange(`A${l}`).format.font.bold=!0,s.getRange(`A${l+1}:B${l+1}`).values=[["Ready","Price verified â€” safe to enter into ERP"]],s.getRange(`A${l+1}:B${l+1}`).format.fill.color=V,s.getRange(`A${l+2}:B${l+2}`).values=[["Review","Price mismatch â€” operator decision needed"]],s.getRange(`A${l+2}:B${l+2}`).format.fill.color=Y,s.getRange(`A${l+3}:B${l+3}`).values=[["Hold","Missing from ERP or data issue â€” cannot enter"]],s.getRange(`A${l+3}:B${l+3}`).format.fill.color=_,s.getRange(`A1:${m}${l+3}`).format.autofitColumns()}else s.getRange(`A1:${m}10`).format.autofitColumns();s.activate(),await t.sync()})}(n);const a=n.totals;let s="ERP staging sheet created.\n\n";return s+=`PO Reference: ${n.metadata.poRef}\n`,s+=`Total lines: ${a.lineCount}\n`,s+=`Total value: ${r(a.totalValue)}\n\n`,s+="Status breakdown:\n",s+=`  Ready (green):  ${a.readyCount} â€” safe to enter into ERP\n`,s+=`  Review (yellow): ${a.reviewCount} â€” price exceptions, operator decision needed\n`,s+=`  Hold (red):     ${a.holdCount} â€” missing from ERP or data issue\n\n`,s+="The ERPStaging sheet has been activated. Green rows can be entered directly. Yellow rows need price confirmation. Red rows need item verification.",s}Office.onReady(()=>{}),Office.actions.associate("ExtractPOData",async e=>{try{return await async function(e){const t=e?JSON.parse(e):{},s=t.sheetName||null;let i;n(t.currency??"GBP"),await Excel.run(async e=>{let t;if(s){if(t=e.workbook.worksheets.getItemOrNullObject(s),await e.sync(),t.isNullObject)throw new Error(`Sheet "${s}" not found. Available sheets can be listed.`)}else t=e.workbook.worksheets.getActiveWorksheet();const n=t.getUsedRange();n.load("values"),t.load("name"),await e.sync();const o=n.values;if(!o||o.length<2)throw new Error("Sheet has no data. Open or paste PO data first.");let r=0,a=0;const c=["sku","item","product","price","cost","qty","quantity","description","name","unit","total","amount","date","order"];for(let e=0;e<Math.min(o.length,15);e++){let t=0;for(const n of o[e]){const e=String(n||"").toLowerCase().trim();if(!(e.length>40))for(const n of c)if(e.includes(n)){t++;break}}t>a&&(a=t,r=e)}const l=o[r].map(e=>String(e??"").trim()).filter(Boolean),u=o.slice(r+1).filter(e=>e.some(e=>null!=e&&""!==String(e).trim())).map(e=>{const t={};return l.forEach((n,o)=>{t[n]=null!=e[o]?String(e[o]):""}),t});i={headers:l,rows:u},he.poFilename=t.name});const c=C(i.headers),l=function(e,t){const n=t||C(e.headers);if(!n.sku)throw new Error("Cannot find SKU column. Available headers: "+e.headers.join(", "));const o=[],r=[];let s=null,i=null;for(let t=0;t<e.rows.length;t++){const c=e.rows[t],l=t+1,u=F(c[n.sku]);if(!u){r.push({line:l,field:"SKU",message:"Empty SKU â€” row skipped"});continue}const f=n.price?c[n.price]:null,g=null!=f?a(f):null;n.price&&null===g&&f&&r.push({line:l,field:"Price",message:`Non-numeric price: "${f}"`});const d=n.qty?c[n.qty]:null,m=null!=d?a(d):null;n.qty&&null===m&&d&&r.push({line:l,field:"Qty",message:`Non-numeric quantity: "${d}"`}),null!==m&&m<=0&&r.push({line:l,field:"Qty",message:`Zero or negative quantity: ${m}`});const p=n.name?F(c[n.name]):"",h=n.deliveryDate?O(c[n.deliveryDate]):null,y=n.uom?F(c[n.uom]):"",$=n.lineTotal?c[n.lineTotal]:null;let w=null!=$?a($):null;if(null===w&&null!==g&&null!==m&&(w=Math.round(g*m*100)/100),null!==w&&null!==g&&null!==m){const e=Math.round(g*m*100)/100;Math.abs(w-e)>.02&&r.push({line:l,field:"Line Total",message:`Mismatch: ${w} vs expected ${e} (price Ã— qty)`})}if(!s&&n.poRef){const e=F(c[n.poRef]);e&&(s=e)}if(!i&&n.customer){const e=F(c[n.customer]);e&&(i=e)}o.push({lineNum:l,sku:u,name:p,qty:m??1,price:g??0,uom:y,lineTotal:w??0,deliveryDate:h||"",status:"Pending"})}const c=o.map(e=>e.qty).filter(e=>e>0).sort((e,t)=>e-t);if(c.length>=5){const e=c[Math.floor(c.length/2)],t=3*e;for(const n of o)n.qty>t&&r.push({line:n.lineNum,field:"Qty",message:`Unusually large quantity: ${n.qty} (median: ${e})`})}const l=o.reduce((e,t)=>e+t.lineTotal,0);return{stagingRows:o,metadata:{lineCount:o.length,totalValue:Math.round(100*l)/100,poRef:s||"Unknown",customer:i||"Unknown",detectedFields:Object.entries(n).filter(([,e])=>null!==e).map(([e])=>e),warningCount:r.length,extractedAt:(new Date).toISOString()},warnings:r}}(i,c);await async function(e){const{stagingRows:t,metadata:n,warnings:a}=e;await Excel.run(async e=>{const s=`Staging_${(n.poRef||"PO").replace(/[^a-zA-Z0-9-_]/g,"").slice(0,20)}`,i=e.workbook.worksheets.getItemOrNullObject(s);await e.sync(),i.isNullObject||(i.delete(),await e.sync());const c=e.workbook.worksheets.add(s),l=[["PO Staging Sheet",""],["PO Reference",n.poRef],["Customer",n.customer],["Line Items",n.lineCount],["Total Value",r(n.totalValue)],["Warnings",n.warningCount],["Extracted",(new Date).toLocaleString()]];c.getRange("A1:B7").values=l;const u=c.getRange("A1:B1");if(u.merge(),u.format.font.bold=!0,u.format.font.size=14,u.format.font.color=D,c.getRange("A2:A7").format.font.bold=!0,n.warningCount>0){const e=c.getRange("B6");e.format.font.color="#A4262C",e.format.font.bold=!0}const f=c.getRange("A9:I9");if(f.values=[T],f.format.font.bold=!0,f.format.font.color=A,f.format.fill.color=D,c.freezePanes.freezeRows(9),t.length>0){const e=new Map;for(const t of a)e.has(t.line)||e.set(t.line,[]),e.get(t.line).push(`${t.field}: ${t.message}`);const r=t.map(t=>[t.lineNum,t.sku,t.name,t.qty,t.price,t.uom,t.lineTotal,t.deliveryDate,e.has(t.lineNum)?"Review":t.status]),s=10,i=s+r.length-1;c.getRange(`A${s}:I${i}`).values=r;for(const e of["E","G"])c.getRange(`${e}${s}:${e}${i}`).numberFormat=[[o()]];c.getRange(`H${s}:H${i}`).numberFormat=[["yyyy-mm-dd"]];for(let n=0;n<t.length;n++){const o=c.getRange(`A${s+n}:I${s+n}`);e.has(t[n].lineNum)?(o.format.fill.color="#FFEB9C",c.getRange(`I${s+n}`).note=e.get(t[n].lineNum).join("\n")):o.format.fill.color="#E2EFDA"}const l=i+1,u=c.getRange(`A${l}:I${l}`);u.values=[["","","",t.reduce((e,t)=>e+t.qty,0),"","",n.totalValue,"",`${t.length} lines`]],u.format.font.bold=!0,c.getRange(`G${l}`).numberFormat=[[o()]],c.getRange(`A1:I${l}`).format.autofitColumns()}else c.getRange("A1:I9").format.autofitColumns();if(a.length>0){const t=s+"_Warnings",n=e.workbook.worksheets.getItemOrNullObject(t);await e.sync(),n.isNullObject||(n.delete(),await e.sync());const o=e.workbook.worksheets.add(t),r=["Line","Field","Warning"],i=o.getRange("A1:C1");i.values=[r],i.format.font.bold=!0,i.format.font.color=A,i.format.fill.color="#A4262C";const c=a.map(e=>[e.line,e.field,e.message]);o.getRange(`A2:C${1+c.length}`).values=c,o.getRange(`A1:C${1+c.length}`).format.autofitColumns()}c.activate(),await e.sync()})}(l);const u=function(e){const t=[...(n=e,0===n.length?[{severity:"error",rule:"no-data",message:"No data rows found. Check the source file."}]:[]),...I(e),...U(e),...M(e),...B(e),...q(e),...K(e),...L(e),...j(e)];var n;const o=t.filter(e=>"error"===e.severity),r=t.filter(e=>"warning"===e.severity),a=t.filter(e=>"info"===e.severity);return{valid:0===o.length,errors:o,warnings:r,info:a,summary:{total:t.length,errors:o.length,warnings:r.length,info:a.length}}}(l.stagingRows);he.lastExtraction=l,he.lastValidation=u;const f=l.metadata,g=f.detectedFields.join(", ");let d="PO data extracted and staging sheet created.\n\n";if(d+=`PO Reference: ${f.poRef}\n`,d+=`Customer: ${f.customer}\n`,d+=`Line items: ${f.lineCount}\n`,d+=`Total value: ${r(f.totalValue)}\n`,d+=`Detected fields: ${g}\n`,d+="\n--- Validation ---\n",d+=function(e){const t=[];if(e.valid?t.push("Validation passed."):t.push(`Validation failed â€” ${e.summary.errors} error(s) must be resolved.`),e.summary.warnings>0&&t.push(`${e.summary.warnings} warning(s) to review.`),e.errors.length>0){t.push(""),t.push("Errors:");for(const n of e.errors)t.push(`  âœ— ${n.message}`)}if(e.warnings.length>0){t.push(""),t.push("Warnings:");for(const n of e.warnings)t.push(`  ! ${n.message}`)}if(e.info.length>0){t.push(""),t.push("Info:");for(const n of e.info)t.push(`  â—‹ ${n.message}`)}return t.join("\n")}(u),f.warningCount>0){d+=`\n\nExtraction warnings: ${f.warningCount}\n`;const e=l.warnings.slice(0,5);for(const t of e)d+=`  Line ${t.line}: ${t.field} â€” ${t.message}\n`;l.warnings.length>5&&(d+=`  ... and ${l.warnings.length-5} more (see Warnings sheet)\n`),d+="\nYellow-highlighted rows need review. Check cell notes for details."}return u.valid?d+="\n\nData is ready for reconciliation.":d+="\n\nValidation errors must be resolved before reconciliation.",d}(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("ReconcilePO",async e=>{try{return await ye(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateCreditNote",async()=>{try{return await async function(){if(!he.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Exception"!==o.status&&"Tolerance"!==o.status)continue;if(null==o.poPrice)continue;const e=o.poQty||1,r=$(o.poPrice*e),a=$(-r);t.push({sku:o.sku,name:o.name||"",qty:e,originalPrice:o.poPrice,erpPrice:o.erpPrice,diff:o.diff,lineTotal:r,creditAmount:a}),n=$(n+a)}return{creditRows:t,totals:{lineCount:t.length,totalCredit:n}}}(he.results);await async function(e,t){await Excel.run(async n=>{const a=v("CreditNote"),s=n.workbook.worksheets.getItemOrNullObject(a);await n.sync(),s.isNullObject||(s.delete(),await n.sync());const i=n.workbook.worksheets.add(a),{creditRows:c,totals:l}=e,u=[["Credit Note",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"â€”"],["Total Lines",l.lineCount],["Total Credit",r(l.totalCredit)]];i.getRange("A1:B5").values=u;const f=i.getRange("A1:B1");f.merge(),f.format.font.bold=!0,f.format.font.size=14,f.format.font.color=w,i.getRange("A2:A5").format.font.bold=!0;const g=i.getRange("A5:B5");g.format.font.color=R,g.format.font.bold=!0;const d=i.getRange("A7:H7");if(d.values=[["SKU","Product Name","Qty","PO Price","ERP Price","Diff","Line Total","Credit Amount"]],d.format.font.bold=!0,d.format.font.color=P,d.format.fill.color=w,i.freezePanes.freezeRows(7),c.length>0){const e=c.map(e=>[e.sku,e.name,e.qty,e.originalPrice,null!=e.erpPrice?e.erpPrice:"",null!=e.diff?e.diff:"",e.lineTotal,e.creditAmount]),t=8,n=t+e.length-1;i.getRange(`A${t}:H${n}`).values=e;for(const e of["D","E","F","G","H"])i.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];i.getRange(`H${t}:H${n}`).format.font.color=R;const r=n+1,a=i.getRange(`A${r}:H${r}`);a.values=[["","","","","","","Total Credit:",l.totalCredit]],a.format.font.bold=!0;const s=i.getRange(`H${r}`);s.numberFormat=[[o()]],s.format.font.color=R,i.getRange(`A1:H${r}`).format.autofitColumns()}else i.getRange("A1:H7").format.autofitColumns();i.activate(),await n.sync()})}(e,he.poFilename);const t=e.totals;return`Credit note created.\n\nLines: ${t.lineCount}\nTotal credit: ${r(t.totalCredit)}\n\nThe CreditNote sheet has been activated.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateReInvoice",async()=>{try{return await async function(){if(!he.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e){const t=[];let n=0;for(const o of e.rows){if("Exception"!==o.status&&"Tolerance"!==o.status)continue;if(null==o.erpPrice)continue;const e=o.poQty||1,r=o.erpPrice,a=$(r*e);t.push({sku:o.sku,name:o.name||"",qty:e,originalPrice:o.poPrice,correctedPrice:r,lineTotal:a,diff:o.diff}),n=$(n+a)}return{invoiceRows:t,totals:{lineCount:t.length,totalInvoice:n}}}(he.results),t=he.results.summary.exceptions;await async function(e,t,n){await Excel.run(async a=>{const s=v("ReInvoice"),i=a.workbook.worksheets.getItemOrNullObject(s);await a.sync(),i.isNullObject||(i.delete(),await a.sync());const c=a.workbook.worksheets.add(s),{invoiceRows:l,totals:u}=e,f=[["Corrected Re-Invoice",""],["Date",(new Date).toLocaleDateString()],["PO Reference",t||"â€”"],["Corrected Total",r(u.totalInvoice)],["Price Corrections",n]];c.getRange("A1:B5").values=f;const g=c.getRange("A1:B1");g.merge(),g.format.font.bold=!0,g.format.font.size=14,g.format.font.color=w,c.getRange("A2:A5").format.font.bold=!0;const d=c.getRange("A7:G7");if(d.values=[["SKU","Product Name","Qty","Original Price","Corrected Price","Diff","Line Total"]],d.format.font.bold=!0,d.format.font.color=P,d.format.fill.color=w,c.freezePanes.freezeRows(7),l.length>0){const e=l.map(e=>[e.sku,e.name,e.qty,null!=e.originalPrice?e.originalPrice:"",e.correctedPrice,null!=e.diff?e.diff:"",e.lineTotal]),t=8,n=t+e.length-1;c.getRange(`A${t}:G${n}`).values=e;for(const e of["D","E","F","G"])c.getRange(`${e}${t}:${e}${n}`).numberFormat=[[o()]];const r=n+1,a=c.getRange(`A${r}:G${r}`);a.values=[["","","","","","Total Invoice:",u.totalInvoice]],a.format.font.bold=!0,c.getRange(`G${r}`).numberFormat=[[o()]],c.getRange(`A1:G${r}`).format.autofitColumns()}else c.getRange("A1:G7").format.autofitColumns();c.activate(),await a.sync()})}(e,he.poFilename,t);const n=e.totals;return`Re-invoice created.\n\nLines: ${n.lineCount}\nCorrected total: ${r(n.totalInvoice)}\nPrice corrections: ${t}\n\nThe ReInvoice sheet has been activated. Yellow-highlighted rows indicate price corrections.`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("DraftExceptionEmail",async()=>{try{return await async function(){if(!he.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=function(e,t){const n=function(e){if(!e)return"Unknown";const t=e.replace(/\.[^.]+$/,""),n=t.match(/(?:PO[-_ ]?)(\d+[-\w]*)/i);return n?`PO-${n[1]}`:t}(t),{summary:o,rows:a}=e,s=a.filter(e=>"Exception"===e.status||"Not in ERP"===e.status||"Not in PO"===e.status),i=s.slice(0,3),c=`PO ${n} â€” Reconciliation: ${o.exceptions} exception${1!==o.exceptions?"s":""} found`,l=i.map(e=>"Not in ERP"===e.status?`  - SKU ${e.sku}: Not found in ERP`:"Not in PO"===e.status?`  - SKU ${e.sku}: In ERP but not on PO`:`  - SKU ${e.sku}: PO ${r(e.poPrice)} vs ERP ${r(e.erpPrice)} (diff: ${r(e.diff)})`);return{subject:c,body:`Hi Team,\n\nPO reconciliation for ${n} has been completed. Please see the summary below:\n\n  Total line items:    ${o.total}\n  Perfect matches:     ${o.matches}\n  Within tolerance:    ${o.tolerances}\n  Exceptions:          ${o.exceptions}\n  Total $ exposure:    ${r(o.exposure)}\n\n${o.exceptions>0?`Top exceptions:\n${l.join("\n")}\n${s.length>3?`  ... and ${s.length-3} more\n`:""}`:"All items matched within tolerance."}\nFull reconciliation details are in the Recon sheet attached to this workbook.\n${o.exceptions>0?"\nCredit note and corrected re-invoice sheets have been generated in this workbook.\n":""}\nPlease review and advise on next steps.\n\nBest regards`}}(he.results,he.poFilename);return`Subject: ${e.subject}\n\n${e.body}`}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateERPStaging",async e=>{try{return await $e(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GenerateDashboard",async()=>{try{return await async function(){const e=await ae();if(0===e.length)return"No price history available yet. Run at least one reconciliation to start building history. Each reconciliation automatically saves price data for trend analysis.";const t=J(e);await async function(e){const{metrics:t,topMovers:n,watchList:o}=e;await Excel.run(async e=>{const r=e.workbook.worksheets;try{r.getItem(ie).delete(),await e.sync()}catch{}const a=r.add(ie);a.activate();let s=0;const i=a.getRangeByIndexes(s,0,1,7);i.merge(!0),i.values=[["Price Intelligence Dashboard"]],i.format.font.bold=!0,i.format.font.size=16,i.format.font.color=ce,s+=1;const c=a.getRangeByIndexes(s,0,1,7);c.merge(!0),c.values=[["Generated: "+(new Date).toLocaleDateString("en-GB")]],c.format.font.size=10,c.format.font.color="#797775",s+=2;const l=a.getRangeByIndexes(s,0,1,7);l.merge(!0),l.values=[["Summary"]],l.format.font.bold=!0,l.format.font.size=13,l.format.fill.color=ue,s+=1;const u=[["SKUs Tracked",t.totalSKUs],["Reconciliation Runs",t.totalRuns],["Total Data Points",t.totalRecords],["Avg Price Drift",(t.avgDrift>=0?"+":"")+t.avgDrift.toFixed(2)+"%"],["Exception Rate",t.exceptionRate.toFixed(1)+"%"],["Anomalies Detected",t.anomalyCount]];for(const[e,t]of u){const n=a.getRangeByIndexes(s,0,1,2);n.merge(!0),n.values=[[e]],n.format.font.bold=!0;const o=a.getRangeByIndexes(s,2,1,2);o.merge(!0),o.values=[[t]],o.format.font.color="#1f4e79",o.format.font.size=12,o.format.font.bold=!0,s++}s+=1;const f=a.getRangeByIndexes(s,0,1,7);f.merge(!0),f.values=[["Trend Breakdown"]],f.format.font.bold=!0,f.format.font.size=13,f.format.fill.color=ue,s+=1;const g=[["Trending Up",t.trendingUp,fe],["Trending Down",t.trendingDown,ge],["Stable",t.stable,de],["Insufficient Data",t.insufficientData,"#F2F2F2"]];for(const[e,n,o]of g){const r=a.getRangeByIndexes(s,0,1,2);r.merge(!0),r.values=[[e]];const i=a.getRangeByIndexes(s,2,1,1);if(i.values=[[n]],i.format.font.bold=!0,n>0){const e=Math.min(4,Math.max(1,Math.round(n/t.totalSKUs*4)));a.getRangeByIndexes(s,3,1,e).format.fill.color=o}s++}if(s+=1,n.length>0){const e=a.getRangeByIndexes(s,0,1,7);e.merge(!0),e.values=[["Top Movers â€” Biggest Recent Price Changes"]],e.format.font.bold=!0,e.format.font.size=13,e.format.fill.color=ue,s+=1;const t=["SKU","Product","Change","Change %","Current Price","Trend","Data Points"],o=a.getRangeByIndexes(s,0,1,t.length);o.values=[t],o.format.font.bold=!0,o.format.font.color=le,o.format.fill.color=ce,s+=1;for(const e of n){const t=e.lastChange>=0?"+":"",n=[e.sku,e.name,t+"Â£"+e.lastChange.toFixed(2),t+e.lastChangePct.toFixed(1)+"%","Â£"+e.currentPrice.toFixed(2),e.direction,e.dataPoints],o=a.getRangeByIndexes(s,0,1,n.length);o.values=[n];const r=e.lastChange>0?fe:e.lastChange<0?ge:de;o.format.fill.color=r,s++}s+=1}if(o.length>0){const e=a.getRangeByIndexes(s,0,1,7);e.merge(!0),e.values=[["Watch List â€” SKUs Needing Attention"]],e.format.font.bold=!0,e.format.font.size=13,e.format.fill.color=ue,s+=1;const t=["SKU","Product","Flags","Risk Score","Current Price","Trend"],n=a.getRangeByIndexes(s,0,1,t.length);n.values=[t],n.format.font.bold=!0,n.format.font.color=le,n.format.fill.color=ce,s+=1;for(const e of o){const t=[e.sku,e.name,e.flags.join("; "),e.riskScore,null!=e.currentErpPrice?"Â£"+e.currentErpPrice.toFixed(2):"",e.trend],n=a.getRangeByIndexes(s,0,1,t.length);n.values=[t],e.riskScore>=50?n.format.fill.color=me:n.format.fill.color=pe,s++}s+=1}if(0===n.length&&0===o.length){const e=a.getRangeByIndexes(s,0,1,7);e.merge(!0),e.values=[["Not enough historical data yet. Run more reconciliations to see trends and predictions."]],e.format.font.italic=!0,e.format.font.color="#797775",s+=2}const d=a.getRangeByIndexes(s,0,1,7);d.merge(!0),d.values=[["Legend"]],d.format.font.bold=!0,d.format.font.size=11,s+=1;const m=[[fe,"Price increasing â€” review supplier terms"],[ge,"Price decreasing â€” favorable trend"],[pe,"Watch â€” approaching risk threshold"],[me,"Anomaly â€” price outside expected range"]];for(const[e,t]of m){a.getRangeByIndexes(s,0,1,1).format.fill.color=e;const n=a.getRangeByIndexes(s,1,1,6);n.merge(!0),n.values=[[t]],n.format.font.size=10,n.format.font.color="#605e5c",s++}const p=[110,200,140,90,100,80,85];for(let e=0;e<p.length;e++)a.getRangeByIndexes(0,e,1,1).format.columnWidth=p[e];await e.sync()})}(t);const n=t.metrics;let o="Price Intelligence Dashboard created.\n\n";if(o+=`Data: ${n.totalRecords} records across ${n.totalRuns} reconciliation runs, ${n.totalSKUs} unique SKUs.\n\n`,o+="Key metrics:\n",o+=`  Average price drift: ${n.avgDrift>=0?"+":""}${n.avgDrift.toFixed(2)}%\n`,o+=`  Exception rate: ${n.exceptionRate.toFixed(1)}%\n`,o+=`  Anomalies detected: ${n.anomalyCount}\n\n`,o+="Trend breakdown:\n",o+=`  Trending up: ${n.trendingUp} SKUs\n`,o+=`  Trending down: ${n.trendingDown} SKUs\n`,o+=`  Stable: ${n.stable} SKUs\n`,t.topMovers.length>0){o+="\nTop movers (biggest recent price changes):\n";for(const e of t.topMovers.slice(0,5)){const t=e.lastChange>=0?"+":"";o+=`  ${e.sku} ${e.name}: ${t}Â£${e.lastChange.toFixed(2)} (${t}${e.lastChangePct.toFixed(1)}%)\n`}}if(t.watchList.length>0){o+="\nWatch list (SKUs needing attention):\n";for(const e of t.watchList.slice(0,5))o+=`  ${e.sku} ${e.name} â€” ${e.flags.join(", ")}\n`}return o+="\nThe Dashboard sheet has been activated with full details.",o}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("GetPriceIntelligence",async()=>{try{return await async function(){const e=await ae();return 0===e.length?"No price history available yet. Run at least one reconciliation to start building history.":function(e){const{metrics:t,topMovers:n,watchList:o}=e,r=[];if(r.push("PRICE INTELLIGENCE REPORT"),r.push("=".repeat(40)),r.push(""),r.push("SUMMARY"),r.push(`  SKUs tracked: ${t.totalSKUs}`),r.push(`  Data points: ${t.totalRecords}`),r.push(`  PO runs analyzed: ${t.totalRuns}`),r.push(`  Avg ERP price drift: ${t.avgDrift>=0?"+":""}${t.avgDrift.toFixed(2)}%`),r.push(`  Exception rate: ${t.exceptionRate.toFixed(1)}%`),r.push(`  Anomalies detected: ${t.anomalyCount}`),r.push(""),r.push("TREND BREAKDOWN"),r.push(`  Trending up: ${t.trendingUp} SKUs`),r.push(`  Trending down: ${t.trendingDown} SKUs`),r.push(`  Stable: ${t.stable} SKUs`),r.push(`  Insufficient data: ${t.insufficientData} SKUs`),r.push(""),n.length>0){r.push("TOP MOVERS (biggest recent price changes)");for(const e of n){const t=e.lastChange>=0?"+":"";r.push(`  ${e.sku} ${e.name}`),r.push(`    Change: ${t}Â£${e.lastChange.toFixed(2)} (${t}${e.lastChangePct.toFixed(1)}%) â†’ Â£${e.currentPrice.toFixed(2)}`)}r.push("")}if(o.length>0){r.push("WATCH LIST (SKUs needing attention)");for(const e of o)r.push(`  ${e.sku} ${e.name} â€” ${e.flags.join(", ")}`);r.push("")}return 0===n.length&&0===o.length&&(r.push("No significant price movements or anomalies detected."),r.push("")),r.join("\n")}(J(e))}()}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("LookupSKU",async e=>{try{return await async function(e){const t=((e?JSON.parse(e):{}).sku||"").trim().toUpperCase();if(!t)return"Please provide a SKU to look up.";const n=await ae();if(0===n.length)return"No price history available yet. Run at least one reconciliation first.";const o=n.filter(e=>{const n=e.sku.trim().toUpperCase();return n===t||n.startsWith(t)||t.startsWith(n)});if(0===o.length)return`SKU "${t}" not found in price history. Available SKUs can be seen in the Dashboard.`;const r=[...o].sort((e,t)=>e.date.localeCompare(t.date)),a=r[r.length-1],s=a.name||r.find(e=>e.name)?.name||"",i=[];i.push(`SKU LOOKUP: ${t}`),s&&i.push(`Product: ${s}`),i.push(`Data points: ${r.length}`),i.push(`Date range: ${r[0].date} to ${a.date}`),i.push(""),i.push("PRICE HISTORY");for(const e of r){const t=null!=e.poPrice?`PO Â£${e.poPrice.toFixed(2)}`:"",n=null!=e.erpPrice?`ERP Â£${e.erpPrice.toFixed(2)}`:"",o=null!=e.diff?`Diff Â£${e.diff.toFixed(2)}`:"";i.push(`  ${e.date}  ${e.poRef}  ${t}  ${n}  ${o}  [${e.status}]`)}i.push("");const c=r.filter(e=>null!=e.erpPrice).map(e=>e.erpPrice);if(c.length>=2){const e=c[0],t=c[c.length-1],n=t-e,o=0!==e?(n/e*100).toFixed(1):"N/A",r=n>.01?"INCREASING":n<-.01?"DECREASING":"STABLE";i.push("TREND"),i.push(`  Direction: ${r}`),i.push(`  First ERP price: Â£${e.toFixed(2)}`),i.push(`  Latest ERP price: Â£${t.toFixed(2)}`),i.push(`  Total change: ${n>=0?"+":""}Â£${n.toFixed(2)} (${n>=0?"+":""}${o}%)`);const a=c.reduce((e,t)=>e+t,0)/c.length,s=c.reduce((e,t)=>e+(t-a)**2,0)/(c.length-1),l=Math.sqrt(s);i.push(`  Volatility (std dev): Â£${l.toFixed(2)}`),i.push("")}const l=r.filter(e=>"Exception"===e.status).length,u=(l/r.length*100).toFixed(0);if(i.push("RISK FLAGS"),i.push(`  Exception rate: ${u}% (${l}/${r.length} runs)`),u>=50&&r.length>=2&&i.push("  âš  Frequent exceptions â€” review supplier terms"),c.length>=3){const e=c.slice(0,-1).reduce((e,t)=>e+t,0)/(c.length-1),t=Math.sqrt(c.slice(0,-1).reduce((t,n)=>t+(n-e)**2,0)/(c.length-2));if(t>0){const n=Math.abs((c[c.length-1]-e)/t);n>2&&i.push(`  âš  Price anomaly â€” latest price is ${n.toFixed(1)} std devs from historical mean`)}}return i.join("\n")}(e)}catch(e){return`Error: ${e.message}`}}),Office.actions.associate("AssessPORisk",async()=>{try{return await async function(){if(!he.results)return"No reconciliation results available. Please run ReconcilePO first.";const e=he.results,t=e.summary;let n="";try{const o=await ae();if(o.length>0){const r=J(o),a=r.metrics,s=t.total>0?t.exceptions/t.total*100:0,i=a.exceptionRate,c=s-i;n+="\nHISTORICAL CONTEXT\n",n+=`  Your historical exception rate: ${i.toFixed(1)}%\n`,n+=`  This PO's exception rate: ${s.toFixed(1)}%\n`,n+=c>5?`  âš  This PO has ${c.toFixed(1)}% MORE exceptions than your average\n`:c<-5?`  âœ“ This PO has ${Math.abs(c).toFixed(1)}% FEWER exceptions than your average\n`:"  This PO is within normal range\n";const l=e.rows.filter(e=>"Exception"===e.status),u=[];for(const e of l){const t=e.sku.trim().toUpperCase(),n=r.watchList.find(e=>e.sku===t);n&&u.push({sku:e.sku,flags:n.flags,risk:n.riskScore})}if(u.length>0){n+="\n  SKUs with historical concerns:\n";for(const e of u.slice(0,5))n+=`    ${e.sku} (risk: ${e.risk}/100) â€” ${e.flags.join(", ")}\n`}const f=[];for(const e of l){const t=e.sku.trim().toUpperCase(),n=r.skuAnalysis.get(t);n&&n.anomaly&&f.push(e.sku)}f.length>0&&(n+=`\n  Price anomalies detected in this PO: ${f.join(", ")}\n`)}}catch{}const o=[];o.push("PO RISK ASSESSMENT"),o.push("=".repeat(40)),o.push(""),o.push("OVERVIEW"),o.push(`  PO Reference: ${he.poFilename}`),o.push(`  Total items: ${t.total}`),o.push(`  Matches: ${t.matches} (${t.total>0?(t.matches/t.total*100).toFixed(0):0}%)`),o.push(`  Exceptions: ${t.exceptions} (${t.total>0?(t.exceptions/t.total*100).toFixed(0):0}%)`),o.push(`  Tolerances: ${t.tolerances}`),o.push(`  Warnings: ${t.warnings}`),o.push(`  Total exposure: ${r(t.exposure)}`),o.push("");const a=e.rows.filter(e=>"Exception"===e.status&&null!=e.diff).sort((e,t)=>Math.abs(t.diff)-Math.abs(e.diff));if(a.length>0){o.push("TOP PRICE DISCREPANCIES");for(const e of a.slice(0,8)){const t=e.diff>=0?"+":"",n=e.poQty||1,a=Math.abs(e.diff*n);o.push(`  ${e.sku} ${e.name||""}`),o.push(`    PO: ${r(e.poPrice)} â†’ ERP: ${r(e.erpPrice)}  (${t}${r(e.diff)} per unit, ${r(a)} total)`)}o.push("")}const s=e.rows.filter(e=>"Not in ERP"===e.status);if(s.length>0){o.push(`ITEMS NOT FOUND IN ERP: ${s.length}`);for(const e of s.slice(0,5))o.push(`  ${e.sku} ${e.name||""} â€” ${r(e.poPrice)}`);s.length>5&&o.push(`  ... and ${s.length-5} more`),o.push("")}n&&o.push(n),o.push(""),o.push("RECOMMENDATION");const i=t.total>0?t.exceptions/t.total*100:0,c=t.exposure>100,l=s.length>0;return 0!==i||l?i<=10&&t.exposure<50&&0===s.length?(o.push("  âœ“ ACCEPT WITH REVIEW â€” Minor price discrepancies."),o.push(`  Action: Review ${t.exceptions} exception(s), generate credit note if needed, then process.`)):i<=30&&!c?(o.push("  âš  REVIEW â€” Moderate price discrepancies found."),o.push(`  Action: Generate credit note and re-invoice for ${t.exceptions} exception(s). Contact supplier if patterns persist.`)):(o.push("  ðŸ›‘ ESCALATE â€” Significant pricing issues."),o.push(`  Action: ${t.exceptions} exceptions with ${r(t.exposure)} exposure. Escalate to pricing team before processing.`),l&&o.push(`  ${s.length} item(s) not found in ERP â€” may be new products or incorrect SKUs.`)):(o.push("  âœ“ ACCEPT â€” All prices match or are within tolerance."),o.push("  Action: Generate ERP staging sheet and process the order.")),o.join("\n")}()}catch(e){return`Error: ${e.message}`}})})();